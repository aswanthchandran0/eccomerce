<%- include('./layout/header.ejs')  %>
    <div class="page-wrapper">
        <%- include('./layout/navBar.ejs')-%>
        <main class="main">
        	<div class="page-header text-center" style="background-image: url('assets/images/page-header-bg.jpg')">
        		<div class="container">
        			<h1 class="page-title">Wishlist<span>Shop</span></h1>
        		</div><!-- End .container -->
        	</div><!-- End .page-header -->
            <nav aria-label="breadcrumb" class="breadcrumb-nav">
                <div class="container">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="/">Home</a></li>
                        <li class="breadcrumb-item"><a href="/productList">Shop</a></li>
                        <li class="breadcrumb-item active" aria-current="page">Wishlist</li>
                    </ol>
                </div><!-- End .container -->
            </nav><!-- End .breadcrumb-nav -->

            <div class="page-content">
            	<div class="container">
                    <% if(products && products.length > 0){ %>
					<table class="table table-wishlist table-mobile">
						<thead>
							<tr>
								<th>Product</th>
								<th>Price</th>
								<th>Stock Status</th>
								<th></th>
								<th></th>
							</tr>
						</thead>

						<tbody>
                            <% products.forEach((product)=>{ %>
							<tr>
								<td class="product-col">
									<div class="product">
										<figure class="product-media">
											<a href="/productView?id=<%= product._id %>">
												<img src="<%= product.images[0] %>" alt="<%= product.name %>">
											</a>
										</figure>

										<h3 class="product-title">
											<a href="/productView?id=<%= product._id %>"><%= product.name %></a>
										</h3><!-- End .product-title -->
									</div><!-- End .product -->
								</td>
								<td class="price-col">₹<%= product.price ? product.price.toString() : '0' %></td>
								<td class="stock-col">
                                    <% 
                                        const totalStock = product.variants ? 
                                            product.variants.reduce((sum, variant) => sum + (variant.stock || 0), 0) : 0;
                                    %>
                                    <span class="<%= totalStock === 0 ? 'out-of-stock' : 'in-stock' %>">
                                        <%= totalStock === 0 ? 'Out of stock' : 'In stock' %>
                                    </span>
                                </td>
							
                                <td class="action-col">
                                    <% 
                                        // Check if product is in cart
                                        let inCart = false;
                                        if(userCart && userCart.products) {
                                            inCart = userCart.products.some(p => 
                                                p.productId && p.productId.toString() === product._id.toString()
                                            );
                                        }
                                    %>
                                    <% if(inCart){ %>
                                        <span class="in-stock" style="color: green; font-weight: bold;">✓ Added to Cart</span>
                                    <% } else if(totalStock > 0) { %>
                                        <a href="#" class="btn-product btn-cart cart" data-product-id="<%= product._id %>">
                                            <span>Add to Cart</span>
                                        </a>
                                    <% } else { %>
                                        <span class="out-of-stock" style="color: red;">Out of Stock</span>
                                    <% } %>
                                </td>
                                
                              <td class="remove-col">
    <button type="button" 
            class="btn-remove" 
            onclick="confirmDelete('<%= product._id %>', '<%= product.name %>')">
        <i class="icon-close"></i>
    </button>
</td>
							</tr>
                            <% }) %>
						</tbody>
					</table><!-- End .table table-wishlist -->
                    <% } else { %>
                        <div class="empty-wishlist text-center py-5">
                            <div class="empty-icon mb-3">
                                <i class="icon-heart-o" style="font-size: 60px; color: #ccc;"></i>
                            </div>
                            <h3>Your wishlist is empty</h3>
                            <p class="mb-4">You don't have any products in your wishlist yet.</p>
                            <a href="/productList" class="btn btn-primary">Browse Products</a>
                        </div>
                    <% } %>
            	</div><!-- End .container -->
            </div><!-- End .page-content -->
        </main><!-- End .main -->
    </div><!-- End .page-wrapper -->
    <button id="scroll-top" title="Back to Top"><i class="icon-arrow-up"></i></button>

    <!-- Mobile Menu -->
    <%- include('./layout/navBarMobile.ejs') %>

    <!-- Plugins JS File -->
    <script src="assets/js/jquery.min.js"></script>
    <script src="assets/js/bootstrap.bundle.min.js"></script>
    <script src="assets/js/jquery.hoverIntent.min.js"></script>
    <script src="assets/js/jquery.waypoints.min.js"></script>
    <script src="assets/js/superfish.min.js"></script>
    <script src="assets/js/owl.carousel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Main JS File -->
    <script src="assets/js/main.js"></script>
    <script>
        $(document).ready(function (){
            // Handle add to cart clicks
            $(document).on('click', '.cart', function(e){
                e.preventDefault();
                const productId = $(this).data('product-id');
                addToCart(productId, $(this));
            });
            
            // Handle form submissions
            $('.remove-form').on('submit', function(e) {
                if(!confirm('Are you sure you want to remove this item from wishlist?')) {
                    e.preventDefault();
                }
            });
        });

        function addToCart(productId, buttonElement){
            $.ajax({
                type:'POST',
                url:'/addToCart',
                data:{productId:productId},
                success:function(data){
                    if(data.success){
                        // Update cart count in navbar
                        const countElement = document.querySelector('.cart-count');
                        if(countElement) {
                            let currentCount = parseInt(countElement.textContent) || 0;
                            countElement.textContent = currentCount + 1;
                            countElement.style.display = 'inline';
                        } else {
                            // Create cart count if doesn't exist
                            const cartIcon = document.querySelector('.dropdown.cart-dropdown a .icon-shopping-cart');
                            if(cartIcon) {
                                const parent = cartIcon.parentElement;
                                const newCartCount = document.createElement('span');
                                newCartCount.className = 'cart-count';
                                newCartCount.textContent = '1';
                                newCartCount.style.position = 'absolute';
                                newCartCount.style.top = '-8px';
                                newCartCount.style.right = '-8px';
                                newCartCount.style.backgroundColor = 'tomato';
                                newCartCount.style.color = 'white';
                                newCartCount.style.borderRadius = '50%';
                                newCartCount.style.padding = '2px 6px';
                                newCartCount.style.fontSize = '12px';
                                parent.appendChild(newCartCount);
                            }
                        }
                        
                        // Update button to show "Added to Cart" immediately
                        if(buttonElement) {
                            buttonElement.replaceWith('<span class="in-stock" style="color: green; font-weight: bold;">✓ Added to Cart</span>');
                        }
                        
                        // Show success message
                        Swal.fire({
                            icon: "success",
                            title: "Added to Cart!",
                            toast: true,
                            position: "top-end",
                            showConfirmButton: false,
                            timer: 2000
                        });
                        
                        // Reload page after 1 second to sync all data
                        setTimeout(() => {
                            location.reload();
                        }, 1000);
                        
                    } else if(data.notLoggedIn){
                        window.location.href = '/login';
                    } else if(data.productExist){
                        Swal.fire({
                            icon: "info",
                            title: "Already in Cart",
                            text: "This product is already in your cart.",
                            toast: true,
                            position: "top-end",
                            showConfirmButton: false,
                            timer: 2000
                        });
                    } else if(data.outOfStock){
                        Swal.fire({
                            icon: "error",
                            title: "Out of Stock",
                            text: "This product is currently out of stock.",
                            toast: true,
                            position: "top-end",
                            showConfirmButton: false,
                            timer: 2000
                        });
                    } else {
                        Swal.fire({
                            icon: "error",
                            title: "Error",
                            text: "Failed to add product to cart.",
                            toast: true,
                            position: "top-end",
                            showConfirmButton: false,
                            timer: 2000
                        });
                    }
                },
                error: function(xhr, status, error) {
                    Swal.fire({
                        icon: "error",
                        title: "Error",
                        text: "Something went wrong. Please try again.",
                        toast: true,
                        position: "top-end",
                        showConfirmButton: false,
                        timer: 2000
                    });
                }
            });
        }
    </script>


<script>
function confirmDelete(productId, productName) {
    Swal.fire({
        title: 'Are you sure?',
        html: `Remove <strong>${productName}</strong> from your wishlist?`,
        icon: 'warning',
        showCancelButton: true,
        confirmButtonColor: '#d33',
        cancelButtonColor: '#3085d6',
        confirmButtonText: 'Yes, remove it!'
    }).then((result) => {
        if (result.isConfirmed) {
            // User confirmed, proceed with deletion
            window.location.href = `/deleteWishlist/${productId}`;
        }
    });
}
</script>

    <%- include('./layout/footer.ejs')  -%>