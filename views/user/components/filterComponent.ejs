<!-- components/filterComponent.ejs -->
<% 
  // Default values for the component
  const filterCategories = typeof categories !== 'undefined' ? categories : [];
  const filterBrands = typeof brands !== 'undefined' ? brands : [];
  const defaultMinPrice = typeof minPrice !== 'undefined' ? minPrice : 0;
  const defaultMaxPrice = typeof maxPrice !== 'undefined' ? maxPrice : 10000;
%>

<div class="filter-component">
    <!-- Filter Header -->
    <div class="filter-header d-flex justify-content-between align-items-center mb-4">
        <h5 class="m-0">
            <i class="icon-filter mr-2"></i> Filters
        </h5>
        <a href="/productList" class="text-danger small clear-all-filters">
            <i class="icon-close"></i> Clear All
        </a>
    </div>

    <!-- Price Range Filter -->
    <div class="filter-section mb-4">
        <h6 class="filter-title mb-3">Price Range</h6>
        <div class="price-range-filter">
            <div class="price-display text-center mb-3">
                <span class="price-min font-weight-bold">₹<span id="filter-price-min"><%= defaultMinPrice %></span></span>
                <span class="mx-2">-</span>
                <span class="price-max font-weight-bold">₹<span id="filter-price-max"><%= defaultMaxPrice %></span></span>
            </div>
            
            <div class="price-slider-wrapper mb-3">
                <div class="price-slider-track"></div>
                <input type="range" class="price-slider price-slider-min" 
                       min="0" max="<%= defaultMaxPrice %>" 
                       value="<%= defaultMinPrice %>" step="100">
                <input type="range" class="price-slider price-slider-max" 
                       min="0" max="<%= defaultMaxPrice %>" 
                       value="<%= defaultMaxPrice %>" step="100">
            </div>
            
            <div class="price-inputs row">
                <div class="col-6">
                    <div class="form-group">
                        <label class="small mb-1">Min Price</label>
                        <input type="number" class="form-control form-control-sm price-input-min" 
                               min="0" max="<%= defaultMaxPrice %>" value="<%= defaultMinPrice %>">
                    </div>
                </div>
                <div class="col-6">
                    <div class="form-group">
                        <label class="small mb-1">Max Price</label>
                        <input type="number" class="form-control form-control-sm price-input-max" 
                               min="0" max="<%= defaultMaxPrice %>" value="<%= defaultMaxPrice %>">
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Category Filter -->
    <div class="filter-section mb-4">
        <h6 class="filter-title mb-3">Categories</h6>
        <div class="filter-options">
            <% if(filterCategories && filterCategories.length > 0){ %>
                <% filterCategories.forEach((category, index) => { %>
                <div class="filter-option mb-2">
                    <div class="custom-control custom-checkbox">
                        <input type="checkbox" class="custom-control-input filter-checkbox category-checkbox" 
                               id="filter-category-<%= index %>" 
                               value="<%= category._id %>"
                               data-name="<%= category.name %>">
                        <label class="custom-control-label" for="filter-category-<%= index %>">
                            <%= category.name %>
                            <% if(category.productCount) { %>
                            <span class="badge badge-light badge-pill ml-1"><%= category.productCount %></span>
                            <% } %>
                        </label>
                    </div>
                </div>
                <% }) %>
            <% } else { %>
                <p class="text-muted small">No categories available</p>
            <% } %>
        </div>
    </div>

    <!-- Brand Filter -->
    <div class="filter-section mb-4">
        <h6 class="filter-title mb-3">Brands</h6>
        <div class="filter-options">
            <% if(filterBrands && filterBrands.length > 0){ %>
                <% filterBrands.forEach((brand, index) => { %>
                <div class="filter-option mb-2">
                    <div class="custom-control custom-checkbox">
                        <input type="checkbox" class="custom-control-input filter-checkbox brand-checkbox" 
                               id="filter-brand-<%= index %>" 
                               value="<%= brand._id %>"
                               data-name="<%= brand.name %>">
                        <label class="custom-control-label" for="filter-brand-<%= index %>">
                            <%= brand.name %>
                            <% if(brand.productCount) { %>
                            <span class="badge badge-light badge-pill ml-1"><%= brand.productCount %></span>
                            <% } %>
                        </label>
                    </div>
                </div>
                <% }) %>
            <% } else { %>
                <p class="text-muted small">No brands available</p>
            <% } %>
        </div>
    </div>

    <!-- Size Filter -->
    <div class="filter-section mb-4">
        <h6 class="filter-title mb-3">Sizes</h6>
        <div class="filter-options">
            <% const sizes = ['XS', 'S', 'M', 'L', 'XL', 'XXL']; %>
            <% sizes.forEach((size, index) => { %>
            <div class="filter-option mb-2">
                <div class="custom-control custom-checkbox">
                    <input type="checkbox" class="custom-control-input filter-checkbox size-checkbox" 
                           id="filter-size-<%= index %>" 
                           value="<%= size %>"
                           data-name="<%= size %>">
                    <label class="custom-control-label" for="filter-size-<%= index %>">
                        <%= size %>
                    </label>
                </div>
            </div>
            <% }) %>
        </div>
    </div>

    <!-- Apply Filters Button -->
    <button class="btn btn-primary btn-block apply-filters-btn">
        <i class="icon-check mr-2"></i> Apply Filters
    </button>

    <!-- Active Filters (will be populated by JS) -->
    <div class="active-filters mt-4" style="display: none;">
        <h6 class="filter-title mb-2">Active Filters:</h6>
        <div class="filter-tags"></div>
    </div>
</div>

<!-- Filter Component CSS -->
<style>
    .filter-component {
        background: #fff;
        border: 1px solid #eaeaea;
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    
    .filter-header {
        padding-bottom: 10px;
        border-bottom: 1px solid #eaeaea;
    }
    
    .filter-title {
        color: #333;
        font-weight: 600;
        font-size: 0.95rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .filter-section {
        padding-bottom: 15px;
        border-bottom: 1px solid #f5f5f5;
    }
    
    .filter-options {
        max-height: 200px;
        overflow-y: auto;
        padding-right: 10px;
    }
    
    .filter-options::-webkit-scrollbar {
        width: 4px;
    }
    
    .filter-options::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 2px;
    }
    
    .filter-options::-webkit-scrollbar-thumb {
        background: #ccc;
        border-radius: 2px;
    }
    
    /* Price Slider Styles */
    .price-range-filter {
        position: relative;
    }
    
    .price-slider-wrapper {
        position: relative;
        height: 30px;
        margin: 0 10px;
    }
    
    .price-slider-track {
        position: absolute;
        top: 50%;
        left: 0;
        right: 0;
        height: 4px;
        background: #e0e0e0;
        border-radius: 2px;
        transform: translateY(-50%);
    }
    
    .price-slider {
        position: absolute;
        top: 50%;
        left: 0;
        right: 0;
        width: 100%;
        height: 0;
        margin: 0;
        transform: translateY(-50%);
        pointer-events: none;
        -webkit-appearance: none;
        appearance: none;
        background: transparent;
        z-index: 2;
    }
    
    .price-slider::-webkit-slider-thumb {
        pointer-events: all;
        -webkit-appearance: none;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: #26a541;
        border: 3px solid white;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        cursor: pointer;
        transition: all 0.2s ease;
    }
    
    .price-slider::-webkit-slider-thumb:hover {
        background: #1f8a37;
        transform: scale(1.1);
    }
    
    .price-slider::-moz-range-thumb {
        pointer-events: all;
        width: 20px;
        height: 20px;
        border-radius: 50%;
        background: #26a541;
        border: 3px solid white;
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        cursor: pointer;
    }
    
    .price-display {
        font-size: 1.1rem;
        color: #333;
        padding: 8px;
        background: #f8f9fa;
        border-radius: 4px;
    }
    
    /* Custom Checkbox Styles */
    .custom-control-input:checked ~ .custom-control-label::before {
        background-color: #26a541;
        border-color: #26a541;
    }
    
    .custom-control-label {
        cursor: pointer;
        color: #555;
        font-size: 0.9rem;
    }
    
    .custom-control-label:hover {
        color: #333;
    }
    
    /* Active Filters */
    .filter-tags {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
    }
    
    .filter-tag {
        background: #e9f7ef;
        color: #26a541;
        padding: 4px 10px;
        border-radius: 20px;
        font-size: 0.85rem;
        display: inline-flex;
        align-items: center;
        border: 1px solid #c3e6d5;
    }
    
    .filter-tag .remove-tag {
        background: none;
        border: none;
        color: #26a541;
        margin-left: 5px;
        font-size: 1rem;
        line-height: 1;
        padding: 0 2px;
        cursor: pointer;
        opacity: 0.7;
    }
    
    .filter-tag .remove-tag:hover {
        opacity: 1;
    }
    
    /* Apply Button */
    .apply-filters-btn {
        background: linear-gradient(135deg, #26a541 0%, #1f8a37 100%);
        border: none;
        padding: 10px;
        font-weight: 600;
        transition: all 0.3s ease;
    }
    
    .apply-filters-btn:hover {
        background: linear-gradient(135deg, #1f8a37 0%, #176c2c 100%);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(38, 165, 65, 0.2);
    }
    
    /* Mobile Responsive */
    @media (max-width: 768px) {
        .filter-component {
            border: none;
            border-radius: 0;
            box-shadow: none;
        }
        
        .filter-options {
            max-height: 150px;
        }
    }
</style>

<!-- Filter Component JavaScript -->
<script>
    class FilterComponent {
        constructor() {
            this.init();
        }
        
        init() {
            this.initPriceSlider();
            this.bindEvents();
            this.updateActiveFilters();
        }
        
        initPriceSlider() {
            const minSlider = document.querySelector('.price-slider-min');
            const maxSlider = document.querySelector('.price-slider-max');
            const minInput = document.querySelector('.price-input-min');
            const maxInput = document.querySelector('.price-input-max');
            const minDisplay = document.querySelector('#filter-price-min');
            const maxDisplay = document.querySelector('#filter-price-max');
            
            if (!minSlider || !maxSlider) return;
            
            // Update display when sliders change
            [minSlider, maxSlider].forEach(slider => {
                slider.addEventListener('input', () => {
                    this.updatePriceDisplay();
                    this.syncPriceInputs();
                });
            });
            
            // Update sliders when inputs change
            [minInput, maxInput].forEach(input => {
                input.addEventListener('change', () => {
                    this.syncPriceSliders();
                    this.updatePriceDisplay();
                });
            });
            
            // Prevent min > max and max < min
            minSlider.addEventListener('input', () => {
                if (parseInt(minSlider.value) > parseInt(maxSlider.value)) {
                    minSlider.value = maxSlider.value;
                }
            });
            
            maxSlider.addEventListener('input', () => {
                if (parseInt(maxSlider.value) < parseInt(minSlider.value)) {
                    maxSlider.value = minSlider.value;
                }
            });
        }
        
        updatePriceDisplay() {
            const minSlider = document.querySelector('.price-slider-min');
            const maxSlider = document.querySelector('.price-slider-max');
            const minDisplay = document.querySelector('#filter-price-min');
            const maxDisplay = document.querySelector('#filter-price-max');
            
            if (minSlider && maxSlider && minDisplay && maxDisplay) {
                minDisplay.textContent = minSlider.value;
                maxDisplay.textContent = maxSlider.value;
            }
        }
        
        syncPriceInputs() {
            const minSlider = document.querySelector('.price-slider-min');
            const maxSlider = document.querySelector('.price-slider-max');
            const minInput = document.querySelector('.price-input-min');
            const maxInput = document.querySelector('.price-input-max');
            
            if (minSlider && maxSlider && minInput && maxInput) {
                minInput.value = minSlider.value;
                maxInput.value = maxSlider.value;
            }
        }
        
        syncPriceSliders() {
            const minSlider = document.querySelector('.price-slider-min');
            const maxSlider = document.querySelector('.price-slider-max');
            const minInput = document.querySelector('.price-input-min');
            const maxInput = document.querySelector('.price-input-max');
            
            if (minSlider && maxSlider && minInput && maxInput) {
                minSlider.value = minInput.value;
                maxSlider.value = maxInput.value;
            }
        }
        
        bindEvents() {
            // Apply filters button
            document.querySelector('.apply-filters-btn')?.addEventListener('click', () => {
                this.applyFilters();
            });
            
            // Clear all filters
            document.querySelector('.clear-all-filters')?.addEventListener('click', (e) => {
                e.preventDefault();
                this.clearAllFilters();
            });
            
            // Auto-apply when checkboxes change
            document.querySelectorAll('.filter-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', () => {
                    this.updateActiveFilters();
                });
            });
            
            // Sort functionality (if exists on page)
            document.getElementById('sortby')?.addEventListener('change', () => {
                this.applyFilters();
            });
        }
        
        getSelectedFilters() {
            const selectedCategories = [];
            const selectedCategoryNames = [];
            document.querySelectorAll('.category-checkbox:checked').forEach(checkbox => {
                selectedCategories.push(checkbox.value);
                selectedCategoryNames.push(checkbox.getAttribute('data-name'));
            });
            
            const selectedBrands = [];
            const selectedBrandNames = [];
            document.querySelectorAll('.brand-checkbox:checked').forEach(checkbox => {
                selectedBrands.push(checkbox.value);
                selectedBrandNames.push(checkbox.getAttribute('data-name'));
            });
            
            const selectedSizes = [];
            const selectedSizeNames = [];
            document.querySelectorAll('.size-checkbox:checked').forEach(checkbox => {
                selectedSizes.push(checkbox.value);
                selectedSizeNames.push(checkbox.getAttribute('data-name'));
            });
            
            const minPrice = document.querySelector('.price-input-min')?.value || 0;
            const maxPrice = document.querySelector('.price-input-max')?.value || 10000;
            const sortBy = document.getElementById('sortby')?.value || '';
            
            return {
                categories: selectedCategories,
                categoryNames: selectedCategoryNames,
                brands: selectedBrands,
                brandNames: selectedBrandNames,
                sizes: selectedSizes,
                sizeNames: selectedSizeNames,
                minPrice: minPrice,
                maxPrice: maxPrice,
                sortBy: sortBy
            };
        }
        
        updateActiveFilters() {
            const filters = this.getSelectedFilters();
            const filterTagsContainer = document.querySelector('.filter-tags');
            const activeFiltersContainer = document.querySelector('.active-filters');
            
            if (!filterTagsContainer || !activeFiltersContainer) return;
            
            // Clear existing tags
            filterTagsContainer.innerHTML = '';
            
            let hasActiveFilters = false;
            
            // Add category filters
            filters.categoryNames.forEach((name, index) => {
                hasActiveFilters = true;
                filterTagsContainer.innerHTML += `
                    <span class="filter-tag">
                        ${name}
                        <button class="remove-tag" data-type="category" data-index="${index}">&times;</button>
                    </span>
                `;
            });
            
            // Add brand filters
            filters.brandNames.forEach((name, index) => {
                hasActiveFilters = true;
                filterTagsContainer.innerHTML += `
                    <span class="filter-tag">
                        ${name}
                        <button class="remove-tag" data-type="brand" data-index="${index}">&times;</button>
                    </span>
                `;
            });
            
            // Add size filters
            filters.sizeNames.forEach((name, index) => {
                hasActiveFilters = true;
                filterTagsContainer.innerHTML += `
                    <span class="filter-tag">
                        Size: ${name}
                        <button class="remove-tag" data-type="size" data-index="${index}">&times;</button>
                    </span>
                `;
            });
            
            // Add price filter if not default
            if (parseInt(filters.minPrice) > 0 || parseInt(filters.maxPrice) < 10000) {
                hasActiveFilters = true;
                filterTagsContainer.innerHTML += `
                    <span class="filter-tag">
                        ₹${filters.minPrice} - ₹${filters.maxPrice}
                        <button class="remove-tag" data-type="price">&times;</button>
                    </span>
                `;
            }
            
            // Show/hide active filters container
            if (hasActiveFilters) {
                activeFiltersContainer.style.display = 'block';
            } else {
                activeFiltersContainer.style.display = 'none';
            }
            
            // Add click handlers for remove buttons
            filterTagsContainer.querySelectorAll('.remove-tag').forEach(button => {
                button.addEventListener('click', (e) => {
                    const type = e.target.getAttribute('data-type');
                    const index = e.target.getAttribute('data-index');
                    this.removeFilter(type, index);
                });
            });
        }
        
        removeFilter(type, index) {
            switch(type) {
                case 'category':
                    document.querySelectorAll('.category-checkbox')[index].checked = false;
                    break;
                case 'brand':
                    document.querySelectorAll('.brand-checkbox')[index].checked = false;
                    break;
                case 'size':
                    document.querySelectorAll('.size-checkbox')[index].checked = false;
                    break;
                case 'price':
                    // Reset price to default
                    const minSlider = document.querySelector('.price-slider-min');
                    const maxSlider = document.querySelector('.price-slider-max');
                    const minInput = document.querySelector('.price-input-min');
                    const maxInput = document.querySelector('.price-input-max');
                    
                    if (minSlider && maxSlider && minInput && maxInput) {
                        minSlider.value = 0;
                        maxSlider.value = 10000;
                        minInput.value = 0;
                        maxInput.value = 10000;
                        this.updatePriceDisplay();
                    }
                    break;
            }
            this.applyFilters();
        }
        
        clearAllFilters() {
            // Uncheck all checkboxes
            document.querySelectorAll('.filter-checkbox').forEach(checkbox => {
                checkbox.checked = false;
            });
            
            // Reset price slider
            const minSlider = document.querySelector('.price-slider-min');
            const maxSlider = document.querySelector('.price-slider-max');
            const minInput = document.querySelector('.price-input-min');
            const maxInput = document.querySelector('.price-input-max');
            
            if (minSlider && maxSlider && minInput && maxInput) {
                minSlider.value = 0;
                maxSlider.value = 10000;
                minInput.value = 0;
                maxInput.value = 10000;
                this.updatePriceDisplay();
            }
            
            // Reset sort
            const sortSelect = document.getElementById('sortby');
            if (sortSelect) {
                sortSelect.value = '';
            }
            
            // Apply filters
            this.applyFilters();
        }
        
        applyFilters() {
            const filters = this.getSelectedFilters();
            
            // Show loading state on product list
            const productList = document.getElementById('product-list');
            if (productList) {
                productList.innerHTML = `
                    <div class="col-12 text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="sr-only">Loading...</span>
                        </div>
                        <p class="mt-2">Applying filters...</p>
                    </div>
                `;
            }
            
            // Update active filters display
            this.updateActiveFilters();
            
            // Send AJAX request
            fetch('/filterProducts', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(filters)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.filteredProducts) {
                    this.updateProductList(data.filteredProducts);
                } else {
                    console.error('Filter error:', data.error);
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: data.error || 'Failed to apply filters'
                    });
                }
            })
            .catch(error => {
                console.error('Filter error:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Failed to apply filters. Please try again.'
                });
            });
        }
        
        updateProductList(products) {
            const productList = document.getElementById('product-list');
            const showingCount = document.getElementById('showing-count');
            
            if (!productList) return;
            
            if (!products || products.length === 0) {
                productList.innerHTML = `
                    <div class="col-12 text-center py-5">
                        <i class="icon-search" style="font-size: 60px; color: #ccc; margin-bottom: 20px;"></i>
                        <h3>No products found</h3>
                        <p class="text-muted">No products match your selected filters</p>
                        <button class="btn btn-primary mt-3" onclick="filterComponent.clearAllFilters()">Clear Filters</button>
                    </div>
                `;
                
                if (showingCount) {
                    showingCount.textContent = '0';
                }
                return;
            }
            
            // Update showing count
            if (showingCount) {
                showingCount.textContent = products.length;
            }
            
            // Build product grid
            let html = '';
            products.forEach(product => {
                // Calculate total stock
                let totalStock = 0;
                if(product.variants && product.variants.length > 0) {
                    totalStock = product.variants.reduce((sum, variant) => sum + (variant.stock || 0), 0);
                }
                
                // Handle category display
                let categoryDisplay = 'Uncategorized';
                if(product.category) {
                    if(typeof product.category === 'object' && product.category.name) {
                        categoryDisplay = product.category.name;
                    } else if(typeof product.category === 'string') {
                        categoryDisplay = product.category;
                    }
                }
                
                // Handle brand display
                let brandDisplay = '';
                if(product.brand) {
                    if(typeof product.brand === 'object' && product.brand.name) {
                        brandDisplay = product.brand.name;
                    } else if(typeof product.brand === 'string') {
                        brandDisplay = product.brand;
                    }
                }
                
                // Handle price display
                let priceDisplay = '0.00';
                if(product.price) {
                    if(typeof product.price === 'object' && product.price.toString) {
                        priceDisplay = parseFloat(product.price.toString()).toFixed(2);
                    } else if(typeof product.price === 'number') {
                        priceDisplay = product.price.toFixed(2);
                    }
                }
                
                html += `
                    <div class="col-6 col-md-4 col-lg-4 col-xl-3 col-xxl-2">
                        <div class="product">
                            <figure class="product-media">
                                ${totalStock === 0 ? '<span class="product-label label-out">Out of stock</span>' : ''}
                                <a href="/productView?id=${product._id}">
                                    <img src="${product.images && product.images[0] ? product.images[0] : 'assets/images/no-image.jpg'}" 
                                         alt="${product.name || 'Product'}" 
                                         class="product-image"
                                         onerror="this.src='assets/images/no-image.jpg'">
                                </a>
                                <div class="product-action-vertical">
                                    <a href="#" class="btn-product-icon btn-wishlist wishlist btn-expandable" title="Add to wishlist" data-product-id="${product._id}">
                                        <span>add to wishlist</span>
                                    </a>
                                </div>
                                <div class="product-action action-icon-top">
                                    ${totalStock > 0 ? 
                                        `<a href="#" class="btn-product btn-cart cart" data-product-id="${product._id}"><span>add to cart</span></a>` : 
                                        `<span class="btn-product btn-disabled"><span>Out of Stock</span></span>`
                                    }
                                </div>
                            </figure>
                            <div class="product-body">
                                <div class="product-cat">${categoryDisplay}</div>
                                <h3 class="product-title">
                                    <a href="/productView?id=${product._id}">${product.name || 'Product'}</a>
                                </h3>
                                <div class="product-price">₹${priceDisplay}</div>
                                ${brandDisplay ? `<div class="product-brand small text-muted"><i class="icon-tag"></i> ${brandDisplay}</div>` : ''}
                            </div>
                        </div>
                    </div>
                `;
            });
            
            productList.innerHTML = html;
        }
    }
    
    // Initialize filter component when DOM is ready
    document.addEventListener('DOMContentLoaded', () => {
        window.filterComponent = new FilterComponent();
    });
</script>