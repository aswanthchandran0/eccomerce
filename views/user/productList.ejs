<%- include('./layout/header.ejs') %>
<body>
    <div class="page-wrapper"> 
        <%- include('./layout/navBar.ejs')-%>
        <main class="main">
        	<div class="page-header text-center" style="background-image: url('assets/images/page-header-bg.jpg')">
        		<div class="container-fluid">
        			<h1 class="page-title"><span>Shop</span></h1>
        		</div><!-- End .container-fluid -->
        	</div><!-- End .page-header -->
            
            <nav aria-label="breadcrumb" class="breadcrumb-nav mb-2">
                <div class="container-fluid">
                    <ol class="breadcrumb">
                        <li class="breadcrumb-item"><a href="/">Home</a></li>
                        <li class="breadcrumb-item"><a href="/productList">Shop</a></li>
                    </ol>
                </div><!-- End .container-fluid -->
            </nav><!-- End .breadcrumb-nav -->

            <div class="page-content">
                <div class="container-fluid">
                    <div class="row">
                        <!-- Sidebar Filters - USING COMPONENT -->
                        <div class="col-lg-3 col-md-4 col-sm-12">
                            <%- include('./components/filterComponent', {
                                categories: categories,
                                brands: brands,
                                minPrice: 0,
                                maxPrice: 10000
                            }) %>
                        </div><!-- End .col-lg-3 -->

                        <!-- Product List -->
                        <div class="col-lg-9 col-md-8 col-sm-12">
                            <div class="toolbox mb-3">
                                <div class="toolbox-left">
                                    <div class="toolbox-item">
                                        <button class="btn btn-outline-secondary btn-sm d-lg-none" id="mobile-filter-toggle">
                                            <i class="icon-filter"></i> Filters
                                        </button>
                                    </div>
                                </div>
                                <div class="toolbox-center">
                                    <div class="toolbox-info">
                                        <span>Showing <strong id="showing-count"><%= products ? products.length : 0 %></strong> products</span>
                                    </div>
                                </div>
                                <div class="toolbox-right">
                                    <div class="toolbox-item">
                                        <div class="select-custom">
                                            <select name="sortby" id="sortby" class="form-control form-control-sm">
                                                <option value="">Sort by</option>
                                                <option value="price_asc">Price: Low to High</option>
                                                <option value="price_desc">Price: High to Low</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div><!-- End .toolbox -->

                            <!-- Active Filters (Will be populated by filter component) -->
                            <div class="active-filters mb-3" id="active-filters" style="display: none;">
                                <div class="d-flex flex-wrap align-items-center">
                                    <span class="mr-2">Active filters:</span>
                                    <div id="filter-tags"></div>
                                </div>
                            </div>

                            <div class="products">
                                <div id="product-list" class="row">
                                    <% if (products && products.length > 0) { %>
                                        <% products.forEach(product => { %>
                                        <div class="col-6 col-md-4 col-lg-4 col-xl-3 col-xxl-2">
                                            <div class="product">
                                                <figure class="product-media">
                                                    <% 
                                                        // Calculate total stock from variants
                                                        let totalStock = 0;
                                                        if(product.variants && product.variants.length > 0) {
                                                            totalStock = product.variants.reduce((sum, variant) => sum + (variant.stock || 0), 0);
                                                        }
                                                    %>
                                                    <% if(totalStock === 0){ %>
                                                        <span class="product-label label-out">Out of stock</span>
                                                    <% } %>
                                                    
                                                    <a href="/productView?id=<%= product._id %>">
                                                        <img src="<%= product.images[0] %>" alt="<%= product.name %>" class="product-image">
                                                    </a>

                                                    <div class="product-action-vertical">
                                                        <a href="#" class="btn-product-icon btn-wishlist wishlist btn-expandable" title="Add to wishlist" data-product-id="<%= product._id %>">
                                                            <span>add to wishlist</span>
                                                        </a>
                                                    </div><!-- End .product-action -->

                                                    <div class="product-action action-icon-top">
                                                        <% if(totalStock > 0) { %>
                                                            <a href="#" class="btn-product btn-cart cart" data-product-id="<%= product._id %>">
                                                                <span>add to cart</span>
                                                            </a>
                                                        <% } else { %>
                                                            <span class="btn-product btn-disabled" style="background-color: #ccc; cursor: not-allowed;">
                                                                <span>Out of Stock</span>
                                                            </span>
                                                        <% } %>
                                                    </div><!-- End .product-action -->
                                                </figure><!-- End .product-media -->

                                                <div class="product-body">
                                                    <div class="product-cat">
                                                        <a href="#">
                                                            <% if(product.category && product.category.name) { %>
                                                                <%= product.category.name %>
                                                            <% } else if(product.category) { %>
                                                                <%= product.category %>
                                                            <% } else { %>
                                                                Uncategorized
                                                            <% } %>
                                                        </a>
                                                    </div><!-- End .product-cat -->
                                                    <h3 class="product-title">
                                                        <a href="/productView?id=<%= product._id %>"><%= product.name %></a>
                                                    </h3><!-- End .product-title -->
                                                    <div class="product-price">
                                                        ₹<%= product.price ? parseFloat(product.price.toString()) : '0' %>
                                                    </div><!-- End .product-price -->
                                                </div><!-- End .product-body -->
                                            </div><!-- End .product -->
                                        </div><!-- End .col-6 col-md-4 col-lg-4 col-xl-3 col-xxl-2 -->
                                        <% }); %>
                                    <% } else { %>
                                        <div class="col-12 text-center py-5">
                                            <i class="icon-search" style="font-size: 60px; color: #ccc; margin-bottom: 20px;"></i>
                                            <h3>No products found</h3>
                                            <p class="text-muted">Try adjusting your filters or browse our collection</p>
                                            <a href="/productList" class="btn btn-primary mt-3">Reset Filters</a>
                                        </div>
                                    <% } %>
                                </div><!-- End .row -->
                            </div><!-- End .products -->

                            <!-- pagination -->
                            <% if(totalPages > 1) { %>
                                <%- include('./layout/pagination', {
                                    totalPages: totalPages,
                                    currentPage: currentPage,
                                    ITEMS_PER_PAGE: ITEMS_PER_PAGE,
                                    baseUrl: '/productList'
                                }) %>
                            <% } %>
                            <!-- pagination end -->
                        </div><!-- End .col-lg-9 -->
                    </div><!-- End .row -->
                </div><!-- End .container-fluid -->
            </div><!-- End .page-content -->
        </main><!-- End .main -->
    </div><!-- End .page-wrapper -->
    
    <%- include('./layout/navBarMobile.ejs') %>

    <!-- Plugins JS File -->
    <script src="assets/js/jquery.min.js"></script>
    <script src="assets/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <!-- Main JS File -->
    <script src="assets/js/main.js"></script>

    <script>
        $(document).ready(function (){
            // Handle add to cart clicks
            $(document).on('click', '.cart', function(e){
                e.preventDefault();
                const productId = $(this).data('product-id');
                addToCart(productId, $(this));
            });
            
            // Handle wishlist clicks
            $(document).on('click', '.wishlist', function(e){
                e.preventDefault();
                const productId = $(this).data('product-id');
                addToWishlist(productId, $(this));
            });

            // Mobile filter toggle - Simplified
            $('#mobile-filter-toggle').on('click', function() {
                $('.col-lg-3').toggleClass('mobile-visible');
                $('body').toggleClass('filter-sidebar-open');
            });

            // Close mobile sidebar when clicking outside
            $(document).on('click', function(e) {
                if($(e.target).closest('.col-lg-3').length === 0 && 
                   $(e.target).closest('#mobile-filter-toggle').length === 0 &&
                   $('.col-lg-3').hasClass('mobile-visible')) {
                    $('.col-lg-3').removeClass('mobile-visible');
                    $('body').removeClass('filter-sidebar-open');
                }
            });
        });

        function addToCart(productId, buttonElement){
            $.ajax({
                type:'POST',
                url:'/addToCart',
                data:{productId:productId},
                success:function(data){
                    if(data.success){
                        updateCartCount();
                        if(buttonElement) {
                            buttonElement.replaceWith('<span class="btn-product" style="background-color: #28a745; color: white; cursor: default;"><span>✓ Added to Cart</span></span>');
                        }
                        Swal.fire({
                            icon: "success",
                            title: "Added to Cart!",
                            toast: true,
                            position: "top-end",
                            showConfirmButton: false,
                            timer: 2000
                        });
                    } else if(data.notLoggedIn){
                        Swal.fire({
                            icon: "warning",
                            title: "Login Required",
                            text: "Please login to add items to cart",
                            showCancelButton: true,
                            confirmButtonText: "Login",
                            cancelButtonText: "Cancel"
                        }).then((result) => {
                            if (result.isConfirmed) {
                                window.location.href = '/login';
                            }
                        });
                    } else if(data.productExist){
                        Swal.fire({
                            icon: "info",
                            title: "Already in Cart",
                            text: "This product is already in your cart.",
                            toast: true,
                            position: "top-end",
                            showConfirmButton: false,
                            timer: 2000
                        });
                    } else if(data.outOfStock){
                        Swal.fire({
                            icon: "error",
                            title: "Out of Stock",
                            text: "This product is currently out of stock.",
                            toast: true,
                            position: "top-end",
                            showConfirmButton: false,
                            timer: 2000
                        });
                    }
                },
                error: function() {
                    Swal.fire({
                        icon: "error",
                        title: "Error",
                        text: "Something went wrong. Please try again.",
                        toast: true,
                        position: "top-end",
                        showConfirmButton: false,
                        timer: 2000
                    });
                }
            });
        }

        function addToWishlist(productId, buttonElement){
            $.ajax({
                type: 'POST',
                url: '/addToWishlist',
                data: { productId: productId },
                success: function (data) {
                    if(data.notLoggedIn){
                        Swal.fire({
                            icon: "warning",
                            title: "Login Required",
                            text: "Please login to add items to wishlist",
                            showCancelButton: true,
                            confirmButtonText: "Login",
                            cancelButtonText: "Cancel"
                        }).then((result) => {
                            if (result.isConfirmed) {
                                window.location.href = '/login';
                            }
                        });
                    } else if (data.success){
                        if(buttonElement) {
                            buttonElement.replaceWith('<span class="btn-product-icon" style="color: #28a745; cursor: default;"><span>✓ Added to Wishlist</span></span>');
                        }
                        Swal.fire({
                            icon: "success",
                            title: "Added to Wishlist!",
                            toast: true,
                            position: "top-end",
                            showConfirmButton: false,
                            timer: 2000
                        });
                    } else if(data.productExist){
                        Swal.fire({
                            icon: "info",
                            title: "Already in Wishlist",
                            text: "This product is already in your wishlist.",
                            toast: true,
                            position: "top-end",
                            showConfirmButton: false,
                            timer: 2000
                        });
                    }
                },
                error: function() {
                    Swal.fire({
                        icon: "error",
                        title: "Error",
                        text: "Something went wrong. Please try again.",
                        toast: true,
                        position: "top-end",
                        showConfirmButton: false,
                        timer: 2000
                    });
                }
            });
        }

        function updateCartCount() {
            const countElement = document.querySelector('.cart-count');
            if(countElement) {
                let currentCount = parseInt(countElement.textContent) || 0;
                countElement.textContent = currentCount + 1;
                countElement.style.display = 'inline';
            } else {
                const cartIcon = document.querySelector('.dropdown.cart-dropdown a .icon-shopping-cart');
                if(cartIcon) {
                    const parent = cartIcon.parentElement;
                    const newCartCount = document.createElement('span');
                    newCartCount.className = 'cart-count';
                    newCartCount.textContent = '1';
                    newCartCount.style.position = 'absolute';
                    newCartCount.style.top = '-8px';
                    newCartCount.style.right = '-8px';
                    newCartCount.style.backgroundColor = 'tomato';
                    newCartCount.style.color = 'white';
                    newCartCount.style.borderRadius = '50%';
                    newCartCount.style.padding = '2px 6px';
                    newCartCount.style.fontSize = '12px';
                    parent.appendChild(newCartCount);
                }
            }
        }
    </script>

    <style>
        /* Mobile filter styles - Simplified */
        @media (max-width: 991px) {
            .col-lg-3 {
                position: fixed;
                top: 0;
                left: -300px;
                width: 300px;
                height: 100%;
                background: white;
                z-index: 9999;
                padding: 20px;
                overflow-y: auto;
                transition: left 0.3s ease;
                box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            }
            
            .col-lg-3.mobile-visible {
                left: 0;
            }
            
            body.filter-sidebar-open {
                overflow: hidden;
            }
            
            body.filter-sidebar-open::after {
                content: '';
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0,0,0,0.5);
                z-index: 9998;
            }
        }
    </style>
    <%- include('./layout/footer.ejs') %>