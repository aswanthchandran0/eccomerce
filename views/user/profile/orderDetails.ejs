<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Details - <%= order._id.toString().slice(-6).toUpperCase() %></title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Custom CSS -->
    <link rel="stylesheet" href="/assets/css/style.css">
    <style>
        /* Order Details Specific Styles */
        .user-dashboard {
            background-color: #f8f9fa;
            min-height: calc(100vh - 150px);
            padding: 30px 0;
        }
        
        /* IMPROVED SIDEBAR STYLING */
        .user-sidebar {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            height: fit-content;
            position: sticky;
            top: 100px;
            overflow: hidden;
        }
        
        .avatar-initials {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            font-weight: bold;
            color: white;
            margin: 0 auto;
            border: 4px solid white;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .user-name {
            font-weight: 700;
            color: #333;
            margin-bottom: 5px;
        }
        
        .user-email {
            color: #6c757d;
            font-size: 0.9rem;
            margin-bottom: 10px;
        }
        
        .sidebar-menu {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .sidebar-menu li {
            margin-bottom: 8px;
        }
        
        .sidebar-menu a {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            color: #495057;
            text-decoration: none;
            border-radius: 10px;
            transition: all 0.3s ease;
            position: relative;
        }
        
        .sidebar-menu a:hover {
            background: linear-gradient(135deg, rgba(67, 97, 238, 0.1), rgba(58, 12, 163, 0.1));
            color: #4361ee;
            transform: translateX(5px);
        }
        
        .sidebar-menu a.active {
            background: linear-gradient(135deg, #4361ee, #3a0ca3);
            color: white;
            box-shadow: 0 4px 12px rgba(67, 97, 238, 0.3);
        }
        
        .sidebar-menu a i {
            width: 25px;
            font-size: 16px;
        }
        
        .menu-badge {
            margin-left: auto;
            background: #ff6b6b;
            color: white;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        
        .sidebar-menu a.active .menu-badge {
            background: rgba(255, 255, 255, 0.3);
        }
        
        /* Order Content */
        .user-content {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            min-height: 500px;
        }
        
        /* Order Header */
        .order-header {
            background: linear-gradient(135deg, #4361ee, #3a0ca3);
            color: white;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 30px;
            position: relative;
            overflow: hidden;
        }
        
        .order-header::before {
            content: '';
            position: absolute;
            top: -50%;
            right: -50%;
            width: 200px;
            height: 200px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 50%;
        }
        
        .order-header h1 {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 10px;
            position: relative;
            z-index: 1;
        }
        
        .order-meta {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-top: 15px;
            position: relative;
            z-index: 1;
        }
        
        .meta-item {
            display: flex;
            flex-direction: column;
            background: rgba(255, 255, 255, 0.1);
            padding: 10px 15px;
            border-radius: 10px;
            backdrop-filter: blur(10px);
        }
        
        .meta-label {
            font-size: 0.85rem;
            opacity: 0.8;
            margin-bottom: 5px;
        }
        
        .meta-value {
            font-weight: 600;
            font-size: 1.1rem;
        }
        
        /* Status Badges */
        .status-badge {
            padding: 8px 20px;
            border-radius: 25px;
            font-weight: 600;
            font-size: 0.9rem;
            display: inline-block;
            margin-right: 10px;
            position: relative;
            z-index: 1;
        }
        
        .status-pending { background: #fff3cd; color: #856404; }
        .status-processing { background: #cce5ff; color: #004085; }
        .status-shipped { background: #d1ecf1; color: #0c5460; }
        .status-delivered { background: #d4edda; color: #155724; }
        .status-cancelled { background: #f8d7da; color: #721c24; }
        .status-active { background: #d4edda; color: #155724; }
        .status-returned { background: #e2d9f3; color: #4a235a; }
        
        .payment-status {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            padding: 6px 15px;
            border-radius: 20px;
            font-size: 0.85rem;
            position: relative;
            z-index: 1;
            backdrop-filter: blur(10px);
        }
        
        /* Order Summary Card */
        .summary-card {
            background: #f8f9fa;
            border-radius: 15px;
            padding: 25px;
            border: 2px solid #eaeaea;
            transition: all 0.3s ease;
        }
        
        .summary-card:hover {
            border-color: #4361ee;
            box-shadow: 0 5px 15px rgba(67, 97, 238, 0.1);
        }
        
        .summary-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 0;
            border-bottom: 1px solid #dee2e6;
        }
        
        .summary-item:last-child {
            border-bottom: none;
            font-weight: 700;
            font-size: 1.2rem;
            color: #333;
        }
        
        /* FIXED PRODUCT LIST STYLING */
        .product-card {
            border: 2px solid #eaeaea;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            transition: all 0.3s ease;
            background: white;
        }
        
        .product-card:hover {
            border-color: #4361ee;
            box-shadow: 0 5px 15px rgba(67, 97, 238, 0.1);
            transform: translateY(-2px);
        }
        
        .product-image-container {
            width: 100px;
            height: 100px;
            flex-shrink: 0;
            margin-right: 20px;
        }
        
        .product-image {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 10px;
        }
        
        .product-image-placeholder {
            width: 100%;
            height: 100%;
            border-radius: 10px;
            background: linear-gradient(135deg, #f5f7fa, #c3cfe2);
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6c757d;
        }
        
        .product-info {
            flex: 1;
            min-width: 0; /* Important for text truncation */
        }
        
        .product-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
            font-size: 1.1rem;
        }
        
        .product-price {
            font-weight: 700;
            color: #4361ee;
            font-size: 1.2rem;
        }
        
        .product-quantity {
            background: linear-gradient(135deg, #f5f7fa, #e4e7ec);
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.9rem;
            color: #495057;
        }
        
        /* Address Card */
        .address-card-details {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            border-left: 4px solid #4361ee;
            transition: all 0.3s ease;
        }
        
        .address-card-details:hover {
            background: #eef1ff;
        }
        
        .address-type-badge {
            background: #4361ee;
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        /* Timeline */
        .timeline {
            position: relative;
            padding-left: 30px;
        }
        
        .timeline::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 2px;
            background: linear-gradient(to bottom, #4361ee, #3a0ca3);
        }
        
        .timeline-item {
            position: relative;
            margin-bottom: 20px;
        }
        
        .timeline-item::before {
            content: '';
            position: absolute;
            left: -36px;
            top: 5px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #4361ee;
            border: 3px solid white;
            box-shadow: 0 0 0 3px #4361ee;
        }
        
        .timeline-item.active::before {
            background: #28a745;
            box-shadow: 0 0 0 3px #28a745;
        }
        
        .timeline-date {
            font-size: 0.85rem;
            color: #6c757d;
        }
        
        .timeline-title {
            font-weight: 600;
            color: #333;
        }
        
        /* Action Buttons */
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 30px;
            flex-wrap: wrap;
        }
        
        .btn-download {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-download:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(40, 167, 69, 0.3);
            color: white;
        }
        
        .btn-cancel {
            background: linear-gradient(135deg, #dc3545, #c82333);
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-cancel:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(220, 53, 69, 0.3);
            color: white;
        }
        
        .btn-return {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-return:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 107, 107, 0.3);
            color: white;
        }
        
        .btn-track {
            background: linear-gradient(135deg, #007bff, #6610f2);
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 8px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-track:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 123, 255, 0.3);
            color: white;
        }
        
        /* Coupon Styles */
        .coupon-badge {
            background: linear-gradient(135deg, #20c997, #12b886);
            color: white;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 0.85rem;
            font-weight: 500;
        }
        
        .discount-amount {
            color: #28a745;
            font-weight: 600;
        }
        
        /* Responsive */
        @media (max-width: 768px) {
            .order-header {
                padding: 20px;
            }
            
            .order-header h1 {
                font-size: 1.5rem;
            }
            
            .order-meta {
                flex-direction: column;
                gap: 10px;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .action-buttons .btn {
                width: 100%;
            }
            
            .product-card .d-flex {
                flex-direction: column;
            }
            
            .product-image-container {
                width: 100%;
                height: 150px;
                margin-right: 0;
                margin-bottom: 15px;
            }
            
            .product-info {
                width: 100%;
            }
        }
        
        /* Small screens */
        @media (max-width: 576px) {
            .user-content {
                padding: 20px;
            }
            
            .sidebar-menu a {
                padding: 10px;
            }
            
            .avatar-initials {
                width: 60px;
                height: 60px;
                font-size: 22px;
            }
        }
    </style>
</head>
<body>
    <!-- Include Header and Navbar -->
    <%- include('../layout/header.ejs') %>
    <%- include('../layout/navBar.ejs') %>

    <div class="user-dashboard">
        <div class="container-fluid">
            <div class="row">
                <!-- IMPROVED SIDEBAR -->
                <div class="col-lg-3 mb-4 mb-lg-0">
                    <div class="user-sidebar p-4">
                        <div class="text-center mb-4">
                            <!-- Avatar with Initials -->
                            <% 
                                // Get user initials
                                const firstName = user.Fname || '';
                                const lastName = user.Lname || '';
                                const firstInitial = firstName.charAt(0).toUpperCase();
                                const lastInitial = lastName.charAt(0).toUpperCase();
                                const initials = (firstInitial + (lastInitial || '')) || 'U';
                                
                                // Function to generate consistent color from name
                                function stringToColor(str) {
                                    let hash = 0;
                                    for (let i = 0; i < str.length; i++) {
                                        hash = str.charCodeAt(i) + ((hash << 5) - hash);
                                    }
                                    
                                    const colors = [
                                        '#4361ee', '#3a0ca3', '#7209b7', '#f72585', 
                                        '#4cc9f0', '#4895ef', '#560bad', '#b5179e',
                                        '#2a9d8f', '#e9c46a', '#e76f51', '#264653',
                                        '#ef476f', '#06d6a0', '#118ab2', '#073b4c'
                                    ];
                                    
                                    const index = Math.abs(hash) % colors.length;
                                    return colors[index];
                                }
                                
                                const avatarColor = stringToColor(firstName + lastName);
                            %>
                            
                            <div class="avatar-initials" style="background-color: <%= avatarColor %>;">
                                <%= initials %>
                            </div>
                            
                            <h4 class="user-name mt-3"><%= user.Fname %> <%= user.Lname %></h4>
                            <p class="user-email"><%= user.Email %></p>
                            <% if(user.createdAt) { %>
                            <div class="d-flex justify-content-center gap-2 mt-2">
                                <span class="badge bg-primary">Member Since <%= new Date(user.createdAt).getFullYear() %></span>
                            </div>
                            <% } %>
                        </div>
                        
                        <ul class="sidebar-menu">
                            <li>
                                <a href="/userProfile" class="<%= currentPage === 'dashboard' ? 'active' : '' %>">
                                    <i class="fas fa-home"></i>
                                    <span>Dashboard</span>
                                </a>
                            </li>
                            <li>
                                <a href="/userProfile/orders" class="<%= currentPage === 'orders' ? 'active' : '' %>">
                                    <i class="fas fa-shopping-cart"></i>
                                    <span>My Orders</span>
                                    <% if(order.orderCount && order.orderCount > 0) { %>
                                        <span class="menu-badge"><%= order.orderCount %></span>
                                    <% } %>
                                </a>
                            </li>
                            <li>
                                <a href="/userProfile/wallet" class="<%= currentPage === 'wallet' ? 'active' : '' %>">
                                    <i class="fas fa-wallet"></i>
                                    <span>Wallet & Payments</span>
                                    <% if(user.Wallet && user.Wallet > 0) { %>
                                        <span class="menu-badge">₹<%= user.Wallet %></span>
                                    <% } %>
                                </a>
                            </li>
                            <li>
                                <a href="/userProfile/offers" class="<%= currentPage === 'offers' ? 'active' : '' %>">
                                    <i class="fas fa-tag"></i>
                                    <span>Offers & Coupons</span>
                                </a>
                            </li>
                            <li>
                                <a href="/userProfile/addresses" class="<%= currentPage === 'addresses' ? 'active' : '' %>">
                                    <i class="fas fa-map-marker-alt"></i>
                                    <span>Addresses</span>
                                </a>
                            </li>
                            <li>
                                <a href="/wishlist" class="<%= currentPage === 'wishlist' ? 'active' : '' %>">
                                    <i class="fas fa-heart"></i>
                                    <span>Wishlist</span>
                                </a>
                            </li>
                            
                            <li class="mt-4">
                                <form action="/userProfile/signout" method="post" class="d-grid">
                                    <button type="submit" class="btn btn-outline-danger btn-sm">
                                        <i class="fas fa-sign-out-alt"></i> Sign Out
                                    </button>
                                </form>
                            </li>
                        </ul>
                    </div>
                </div>
                
                <!-- Main Content -->
                <div class="col-lg-9">
                    <div class="user-content">
                        <!-- Order Header -->
                        <div class="order-header">
                            <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center">
                                <div class="mb-3 mb-md-0">
                                    <h1>
                                        <i class="fas fa-receipt me-2"></i>
                                        Order #<%= order._id.toString().slice(-6).toUpperCase() %>
                                    </h1>
                                    <p class="mb-0">Placed on <%= new Date(order.orderDate).toLocaleDateString('en-US', { 
                                        weekday: 'long', 
                                        year: 'numeric', 
                                        month: 'long', 
                                        day: 'numeric' 
                                    }) %></p>
                                </div>
                                <div class="text-start text-md-end">
                                    <span class="status-badge status-<%= order.orderStatus.toLowerCase() %>">
                                        <%= order.orderStatus %>
                                    </span>
                                    <span class="payment-status">
                                        <i class="fas fa-credit-card me-1"></i>
                                        <%= order.paymentStatus %>
                                    </span>
                                </div>
                            </div>
                            
                            <div class="order-meta">
                                <div class="meta-item">
                                    <span class="meta-label">Order ID</span>
                                    <span class="meta-value"><%= order._id.toString().slice(-6).toUpperCase() %></span>
                                </div>
                                <div class="meta-item">
                                    <span class="meta-label">Payment Method</span>
                                    <span class="meta-value"><%= order.paymentMethod %></span>
                                </div>
                                <div class="meta-item">
                                    <span class="meta-label">Total Amount</span>
                                    <span class="meta-value">₹<%= order.Total %></span>
                                </div>
                                <div class="meta-item">
                                    <span class="meta-label">Shipping</span>
                                    <span class="meta-value">₹<%= order.shippingPrice %></span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Show cancellation/return reason if exists -->
                        <% if(order.returnReason) { %>
                        <div class="alert alert-info mb-4">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Reason:</strong> <%= order.returnReason %>
                            <% if(order.orderStatus === 'cancelled') { %>
                                <br><small class="text-muted">Order was cancelled</small>
                            <% } else if(order.orderStatus === 'returned') { %>
                                <br><small class="text-muted">Order was returned</small>
                            <% } %>
                        </div>
                        <% } %>
                        
                        <div class="row">
                            <!-- Left Column: Products & Timeline -->
                            <div class="col-lg-8">
                                <!-- Products List -->
                                <div class="mb-4">
                                    <h4 class="mb-4">
                                        <i class="fas fa-box-open me-2"></i>
                                        Order Items (<%= order.productDetails.length %>)
                                    </h4>
                                    
                                    <% order.productDetails.forEach((item, index) => { 
                                        const product = item.productId;
                                    %>
                                    <div class="product-card">
                                        <div class="d-flex flex-column flex-md-row align-items-start align-items-md-center">
                                            <div class="product-image-container">
                                                <% if(product && product.images && product.images.length > 0) { %>
                                                    <img src="<%= product.images[0] %>" alt="<%= product.name %>" class="product-image">
                                                <% } else { %>
                                                    <div class="product-image-placeholder">
                                                        <i class="fas fa-image fa-2x"></i>
                                                    </div>
                                                <% } %>
                                            </div>
                                            
                                            <div class="product-info">
                                                <h5 class="product-name">
                                                    <%= product ? product.name : 'Product Not Found' %>
                                                </h5>
                                                <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center">
                                                    <div class="mb-2 mb-md-0">
                                                        <span class="product-price">₹<%= product ? product.price : 0 %></span>
                                                        <span class="text-muted ms-2">× <%= item.purchasedCount %></span>
                                                        <div class="text-muted mt-1">
                                                            <small>Item Total: ₹<%= product ? (product.price * item.purchasedCount) : 0 %></small>
                                                        </div>
                                                    </div>
                                                    <div class="product-quantity">
                                                        Qty: <%= item.purchasedCount %>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <% }); %>
                                </div>
                                
                                <!-- Order Timeline -->
                                <div class="mb-4">
                                    <h4 class="mb-4">
                                        <i class="fas fa-history me-2"></i>
                                        Order Timeline
                                    </h4>
                                    
                                    <div class="timeline">
                                        <div class="timeline-item <%= order.orderStatus === 'active' ? 'active' : '' %>">
                                            <div class="timeline-date">
                                                <%= new Date(order.orderDate).toLocaleDateString('en-US', { 
                                                    year: 'numeric',
                                                    month: 'short', 
                                                    day: 'numeric',
                                                    hour: '2-digit',
                                                    minute: '2-digit'
                                                }) %>
                                            </div>
                                            <div class="timeline-title">
                                                <i class="fas fa-shopping-cart me-2"></i>
                                                Order Placed
                                            </div>
                                            <p class="mb-0 text-muted">Your order has been successfully placed.</p>
                                        </div>
                                        
                                        <% if(order.orderStatus !== 'cancelled') { %>
                                        <div class="timeline-item <%= order.orderStatus === 'processing' || order.orderStatus === 'shipped' || order.orderStatus === 'delivered' ? 'active' : '' %>">
                                            <div class="timeline-date">
                                                <% if(order.orderStatus === 'processing' || order.orderStatus === 'shipped' || order.orderStatus === 'delivered') { %>
                                                    <%= new Date(order.orderDate.getTime() + 86400000).toLocaleDateString('en-US', { 
                                                        month: 'short', 
                                                        day: 'numeric'
                                                    }) %>
                                                <% } %>
                                            </div>
                                            <div class="timeline-title">
                                                <i class="fas fa-cog me-2"></i>
                                                Processing
                                            </div>
                                            <p class="mb-0 text-muted">We're preparing your order for shipment.</p>
                                        </div>
                                        <% } %>
                                        
                                        <% if(order.orderStatus === 'shipped' || order.orderStatus === 'delivered') { %>
                                        <div class="timeline-item <%= order.orderStatus === 'shipped' || order.orderStatus === 'delivered' ? 'active' : '' %>">
                                            <div class="timeline-date">
                                                <%= new Date(order.orderDate.getTime() + 172800000).toLocaleDateString('en-US', { 
                                                    month: 'short', 
                                                    day: 'numeric'
                                                }) %>
                                            </div>
                                            <div class="timeline-title">
                                                <i class="fas fa-shipping-fast me-2"></i>
                                                Shipped
                                            </div>
                                            <p class="mb-0 text-muted">Your order is on the way!</p>
                                        </div>
                                        <% } %>
                                        
                                        <% if(order.orderStatus === 'delivered' || order.orderStatus === 'returned') { %>
                                        <div class="timeline-item <%= order.orderStatus === 'delivered' ? 'active' : '' %>">
                                            <div class="timeline-date">
                                                <%= new Date(order.orderDate.getTime() + 259200000).toLocaleDateString('en-US', { 
                                                    month: 'short', 
                                                    day: 'numeric'
                                                }) %>
                                            </div>
                                            <div class="timeline-title">
                                                <i class="fas fa-check-circle me-2"></i>
                                                Delivered
                                            </div>
                                            <p class="mb-0 text-muted">Your order has been delivered successfully.</p>
                                        </div>
                                        <% } %>
                                        
                                        <% if(order.orderStatus === 'cancelled') { %>
                                        <div class="timeline-item active">
                                            <div class="timeline-date">
                                                <%= new Date().toLocaleDateString('en-US', { 
                                                    month: 'short', 
                                                    day: 'numeric'
                                                }) %>
                                            </div>
                                            <div class="timeline-title">
                                                <i class="fas fa-times-circle me-2"></i>
                                                Cancelled
                                            </div>
                                            <p class="mb-0 text-muted">Order was cancelled.</p>
                                        </div>
                                        <% } %>
                                        
                                        <% if(order.orderStatus === 'returned') { %>
                                        <div class="timeline-item active">
                                            <div class="timeline-date">
                                                <%= new Date().toLocaleDateString('en-US', { 
                                                    month: 'short', 
                                                    day: 'numeric'
                                                }) %>
                                            </div>
                                            <div class="timeline-title">
                                                <i class="fas fa-undo me-2"></i>
                                                Returned
                                            </div>
                                            <p class="mb-0 text-muted">Order was returned.</p>
                                        </div>
                                        <% } %>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Right Column: Summary & Address -->
                            <div class="col-lg-4">
                                <!-- Order Summary -->
                                <div class="summary-card mb-4">
                                    <h5 class="mb-4">
                                        <i class="fas fa-file-invoice-dollar me-2"></i>
                                        Order Summary
                                    </h5>
                                    
                                    <% 
                                        let subtotal = 0;
                                        order.productDetails.forEach(item => {
                                            const product = item.productId;
                                            if(product && product.price) {
                                                subtotal += product.price * item.purchasedCount;
                                            }
                                        });
                                        
                                        // Use order.subtotal if you have it, otherwise calculate
                                        const preDiscountTotal = order.subtotal || subtotal;
                                        const discountAmount = order.couponApplied?.discountAmount || 0;
                                        const discountPercentage = order.couponApplied?.discountPercentage || 0;
                                        const couponCode = order.couponApplied?.couponCode;
                                    %>
                                    
                                    <div class="summary-item">
                                        <span>Subtotal</span>
                                        <span>₹<%= preDiscountTotal %></span>
                                    </div>
                                    
                                    <% if(couponCode) { %>
                                    <div class="summary-item text-success">
                                        <span>
                                            <i class="fas fa-tag me-1"></i>
                                            Coupon Discount
                                            <% if(couponCode) { %>
                                                <small class="text-muted ms-2">
                                                    (<%= couponCode %>)
                                                </small>
                                            <% } %>
                                        </span>
                                        <span>-₹<%= discountAmount %></span>
                                    </div>
                                    <% } %>
                                    
                                    <div class="summary-item">
                                        <span>Shipping</span>
                                        <span>₹<%= order.shippingPrice %></span>
                                    </div>
                                    
                                    <% if(order.orderStatus === 'cancelled' || order.orderStatus === 'returned') { %>
                                    <div class="summary-item">
                                        <span>Refund Amount</span>
                                        <span class="text-success">₹<%= order.Total %></span>
                                    </div>
                                    <% } %>
                                    
                                    <div class="summary-item">
                                        <span>Total</span>
                                        <span>₹<%= order.Total %></span>
                                    </div>
                                    
                                    <% if(couponCode && discountAmount > 0) { %>
                                   <div class="mt-3 p-3 bg-success-subtle border border-success border-opacity-25 rounded text-center">
    <small class="text-success-emphasis fw-semibold">
        <i class="fas fa-percentage me-1"></i>
        You saved ₹<%= discountAmount %> with coupon!
    </small>
</div>
                                    <% } %>
                                </div>
                                
                                <!-- Shipping Address -->
                                <div class="address-card-details mb-4">
                                    <h5 class="mb-3">
                                        <i class="fas fa-map-marker-alt me-2"></i>
                                        Shipping Address
                                    </h5>
                                    
                                    <div class="mb-3">
                                        <span class="address-type-badge">
                                            <i class="fas fa-<%= order.address.AddressType === 'Home' ? 'home' : order.address.AddressType === 'Office' ? 'building' : 'map-pin' %> me-1"></i>
                                            <%= order.address.AddressType %>
                                        </span>
                                        <% if(order.address.isDefault) { %>
                                            <span class="badge bg-success ms-2">
                                                <i class="fas fa-star me-1"></i> Default
                                            </span>
                                        <% } %>
                                    </div>
                                    
                                    <p class="mb-2">
                                        <strong><%= order.address.Fname %></strong>
                                    </p>
                                    <p class="mb-2">
                                        <i class="fas fa-phone me-2"></i>
                                        <%= order.address.PhoneNumber %>
                                        <% if(order.address.AphoneNumber) { %>
                                            <br>
                                            <small class="text-muted">
                                                <i class="fas fa-phone-alt me-2"></i>
                                                Alternate: <%= order.address.AphoneNumber %>
                                            </small>
                                        <% } %>
                                    </p>
                                    <p class="mb-2">
                                        <i class="fas fa-map-marker-alt me-2"></i>
                                        <%= order.address.Address %>, 
                                        <%= order.address.Place %>, 
                                        <%= order.address.state %> - 
                                        <%= order.address.Pincode %>
                                    </p>
                                    <% if(order.address.LandMark) { %>
                                        <p class="mb-0">
                                            <i class="fas fa-flag me-2"></i>
                                            Landmark: <%= order.address.LandMark %>
                                        </p>
                                    <% } %>
                                </div>
                                
                                <!-- Payment Details Card -->
                                <div class="summary-card">
                                    <h5 class="mb-4">
                                        <i class="fas fa-credit-card me-2"></i>
                                        Payment Details
                                    </h5>
                                    
                                    <div class="summary-item">
                                        <span>Method</span>
                                        <span><%= order.paymentMethod %></span>
                                    </div>
                                    
                                    <div class="summary-item">
                                        <span>Coupon Applied</span>
                                        <span>
                                            <% if(order.couponApplied?.couponCode) { %>
                                                <span class="text-success">
                                                    <i class="fas fa-tag me-1"></i>
                                                    <%= order.couponApplied.couponCode %>
                                                    (<%= discountAmount ? '₹' + discountAmount + ' off' : discountPercentage + '% off' %>)
                                                </span>
                                            <% } else { %>
                                                <span class="text-muted">No coupon applied</span>
                                            <% } %>
                                        </span>
                                    </div>
                                    
                                    <div class="summary-item">
                                        <span>Payment Status</span>
                                        <span class="<%= order.paymentStatus === 'Approved' || order.paymentStatus === 'Refunded' ? 'text-success' : order.paymentStatus === 'Pending' ? 'text-warning' : 'text-danger' %>">
                                            <i class="fas fa-circle me-1"></i>
                                            <%= order.paymentStatus %>
                                        </span>
                                    </div>
                                    
                                    <div class="summary-item">
                                        <span>Order Status</span>
                                        <span class="<%= order.orderStatus === 'active' || order.orderStatus === 'delivered' ? 'text-success' : order.orderStatus === 'cancelled' || order.orderStatus === 'returned' ? 'text-danger' : 'text-warning' %>">
                                            <i class="fas fa-circle me-1"></i>
                                            <%= order.orderStatus %>
                                        </span>
                                    </div>
                                    
                                    <div class="summary-item">
                                        <span>Order Date</span>
                                        <span><%= new Date(order.orderDate).toLocaleDateString('en-US', { 
                                            year: 'numeric',
                                            month: 'short', 
                                            day: 'numeric'
                                        }) %></span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="action-buttons">
                            <a href="/userProfile/orders" class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-left me-2"></i> Back to Orders
                            </a>
                            
                            <!-- Cancel Button - Show only for cancellable orders -->
                            <% if(['active', 'processing', 'pending'].includes(order.orderStatus)) { %>
                                <button class="btn btn-cancel" id="cancelOrderBtn">
                                    <i class="fas fa-times me-2"></i> Cancel Order
                                </button>
                            <% } %>
                            
                            <!-- Return Button - Show only for delivered orders -->
                            <% if(order.orderStatus === 'delivered') { %>
                                <button class="btn btn-return" id="returnOrderBtn">
                                    <i class="fas fa-undo me-2"></i> Return Order
                                </button>
                            <% } %>
                            
                            <!-- Invoice Button - Show for all orders except cancelled/returned -->
                            <% if(!['cancelled', 'returned'].includes(order.orderStatus)) { %>
                                <a href="/orderDetails/inVoice?orderId=<%= order._id %>" target="_blank" class="btn btn-download">
                                    <i class="fas fa-download me-2"></i> Download Invoice
                                </a>
                            <% } else { %>
                                <a href="/orderDetails/inVoice?orderId=<%= order._id %>" target="_blank" class="btn btn-outline-primary">
                                    <i class="fas fa-file-invoice me-2"></i> View Invoice
                                </a>
                            <% } %>
                            
                            <!-- Track Button - Show only for shipped orders -->
                            <% if(order.orderStatus === 'shipped') { %>
                                <button class="btn btn-track">
                                    <i class="fas fa-truck me-2"></i> Track Order
                                </button>
                            <% } %>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Include Mobile Navbar and Footer -->
    <%- include('../layout/navBarMobile.ejs') %>
    <%- include('../layout/footer.ejs') %>
    
    <!-- JavaScript -->
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <script>
        $(document).ready(function() {
            // Highlight active sidebar link
            const currentPath = window.location.pathname;
            $('.sidebar-menu a').each(function() {
                if ($(this).attr('href') === '/userProfile/orders') {
                    $(this).addClass('active');
                }
            });
            
            // Cancel Order
            $('#cancelOrderBtn').on('click', function() {
                Swal.fire({
                    title: 'Cancel Order?',
                    text: "Are you sure you want to cancel this order? This action cannot be undone.",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#dc3545',
                    cancelButtonColor: '#6c757d',
                    confirmButtonText: 'Yes, cancel it!',
                    cancelButtonText: 'No, keep it',
                    background: 'white',
                    backdrop: 'rgba(0,0,0,0.5)'
                }).then((result) => {
                    if (result.isConfirmed) {
                        // Show loading
                        const btn = $(this);
                        const originalText = btn.html();
                        btn.html('<i class="fas fa-spinner fa-spin me-2"></i> Cancelling...').prop('disabled', true);
                        
                        $.ajax({
                            url: '/orderDetails/delete/<%= order._id %>',
                            method: 'POST',
                            data: {
                                reason: 'Customer requested cancellation'
                            },
                            success: function(response) {
                                if (response.success) {
                                    Swal.fire({
                                        icon: 'success',
                                        title: 'Cancelled!',
                                        text: 'Your order has been cancelled successfully. Refund will be processed to your wallet.',
                                        confirmButtonColor: '#4361ee',
                                        background: 'white'
                                    }).then(() => {
                                        location.reload();
                                    });
                                } else {
                                    Swal.fire({
                                        icon: 'error',
                                        title: 'Error',
                                        text: response.error || 'Failed to cancel order',
                                        confirmButtonColor: '#4361ee',
                                        background: 'white'
                                    });
                                    btn.html(originalText).prop('disabled', false);
                                }
                            },
                            error: function() {
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Error',
                                    text: 'An error occurred while cancelling the order',
                                    confirmButtonColor: '#4361ee',
                                    background: 'white'
                                });
                                btn.html(originalText).prop('disabled', false);
                            }
                        });
                    }
                });
            });
            
            // Return Order
            $('#returnOrderBtn').on('click', function() {
                Swal.fire({
                    title: 'Return Order?',
                    text: "Are you sure you want to return this order? This will process a refund to your wallet.",
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonColor: '#ff6b6b',
                    cancelButtonColor: '#6c757d',
                    confirmButtonText: 'Yes, return it!',
                    cancelButtonText: 'No, keep it',
                    background: 'white',
                    backdrop: 'rgba(0,0,0,0.5)'
                }).then((result) => {
                    if (result.isConfirmed) {
                        // Show loading
                        const btn = $(this);
                        const originalText = btn.html();
                        btn.html('<i class="fas fa-spinner fa-spin me-2"></i> Processing...').prop('disabled', true);
                        
                        // Call your new return API endpoint
                        $.ajax({
                            url: '/order/return/<%= order._id %>',
                            method: 'POST',
                            data: {
                                reason: 'Customer requested return'
                            },
                            success: function(response) {
                                if (response.success) {
                                    Swal.fire({
                                        icon: 'success',
                                        title: 'Return Requested!',
                                        text: 'Your return request has been submitted. Refund will be processed to your wallet.',
                                        confirmButtonColor: '#4361ee',
                                        background: 'white'
                                    }).then(() => {
                                        location.reload();
                                    });
                                } else {
                                    Swal.fire({
                                        icon: 'error',
                                        title: 'Error',
                                        text: response.error || 'Failed to process return',
                                        confirmButtonColor: '#4361ee',
                                        background: 'white'
                                    });
                                    btn.html(originalText).prop('disabled', false);
                                }
                            },
                            error: function() {
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Error',
                                    text: 'An error occurred while processing return',
                                    confirmButtonColor: '#4361ee',
                                    background: 'white'
                                });
                                btn.html(originalText).prop('disabled', false);
                            }
                        });
                    }
                });
            });
            
            // Track Order Button (if you want to implement tracking)
            $('.btn-track').on('click', function() {
                Swal.fire({
                    title: 'Track Order',
                    text: 'Tracking feature coming soon!',
                    icon: 'info',
                    confirmButtonColor: '#4361ee',
                    background: 'white'
                });
            });
            
            // Update order status color based on status
            const orderStatus = '<%= order.orderStatus.toLowerCase() %>';
            const statusColors = {
                'active': '#28a745',
                'processing': '#17a2b8',
                'shipped': '#007bff',
                'delivered': '#20c997',
                'cancelled': '#dc3545',
                'returned': '#ff6b6b',
                'pending': '#ffc107'
            };
            
            if (statusColors[orderStatus]) {
                $('.order-header').css('background', `linear-gradient(135deg, ${statusColors[orderStatus]}, ${darkenColor(statusColors[orderStatus], 20)})`);
            }
            
            function darkenColor(color, percent) {
                const num = parseInt(color.replace("#", ""), 16);
                const amt = Math.round(2.55 * percent);
                const R = (num >> 16) - amt;
                const G = (num >> 8 & 0x00FF) - amt;
                const B = (num & 0x0000FF) - amt;
                return "#" + (0x1000000 + (R < 255 ? R < 1 ? 0 : R : 255) * 0x10000 +
                    (G < 255 ? G < 1 ? 0 : G : 255) * 0x100 +
                    (B < 255 ? B < 1 ? 0 : B : 255)).toString(16).slice(1);
            }
        });
    </script>
</body>
</html>