<%- include('./layout/header.ejs') -%>
<% currentPage = 'Coupon Management' %>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
<style>
  .coupon-container {
    background: white;
    border-radius: 15px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    overflow: hidden;
  }

  .coupon-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 25px 30px;
    border-radius: 15px 15px 0 0;
  }

  .coupon-header h3 {
    margin: 0;
    font-weight: 600;
    font-size: 1.8rem;
  }

  .coupon-header .btn-add {
    background: rgba(255, 255, 255, 0.2);
    border: 2px solid rgba(255, 255, 255, 0.3);
    color: white;
    padding: 10px 25px;
    border-radius: 50px;
    font-weight: 500;
    transition: all 0.3s ease;
  }

  .coupon-header .btn-add:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: translateY(-2px);
  }

  .coupon-table {
    padding: 25px;
  }

  .coupon-card {
    background: #f8f9fa;
    border-radius: 12px;
    padding: 20px;
    margin-bottom: 20px;
    border: 1px solid #e9ecef;
    transition: all 0.3s ease;
  }

  .coupon-card:hover {
    transform: translateY(-3px);
    box-shadow: 0 6px 15px rgba(0, 0, 0, 0.1);
    border-color: #667eea;
  }

  .coupon-code {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 8px 15px;
    border-radius: 25px;
    font-weight: 600;
    font-size: 0.9rem;
    display: inline-block;
    margin-bottom: 10px;
  }

  .coupon-name {
    font-size: 1.1rem;
    font-weight: 600;
    color: #333;
    margin-bottom: 8px;
  }

  .coupon-details {
    color: #666;
    font-size: 0.9rem;
    margin-bottom: 5px;
  }

  .coupon-details i {
    width: 20px;
    color: #667eea;
  }

  .coupon-status {
    display: inline-block;
    padding: 5px 15px;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 500;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }

  .status-active {
    background: rgba(46, 204, 113, 0.1);
    color: #2ecc71;
    border: 1px solid rgba(46, 204, 113, 0.3);
  }

  .status-inactive {
    background: rgba(231, 76, 60, 0.1);
    color: #e74c3c;
    border: 1px solid rgba(231, 76, 60, 0.3);
  }

  .status-expired {
    background: rgba(149, 165, 166, 0.1);
    color: #95a5a6;
    border: 1px solid rgba(149, 165, 166, 0.3);
  }

  .coupon-actions {
    display: flex;
    gap: 10px;
    margin-top: 15px;
  }

  .coupon-actions .btn {
    padding: 8px 15px;
    font-size: 0.85rem;
    border-radius: 8px;
    border: none;
    transition: all 0.3s ease;
  }

  .btn-toggle {
    background: #3498db;
    color: white;
  }

  .btn-toggle:hover {
    background: #2980b9;
    transform: translateY(-2px);
  }

  .btn-delete {
    background: #e74c3c;
    color: white;
  }

  .btn-delete:hover {
    background: #c0392b;
    transform: translateY(-2px);
  }

  /* Add Coupon Modal Styles */
  .modal-overlay {
    display: none;
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 1050;
    align-items: center;
    justify-content: center;
  }

  .modal-content {
    background: white;
    border-radius: 15px;
    width: 90%;
    max-width: 600px;
    max-height: 90vh;
    overflow-y: auto;
    animation: modalSlideIn 0.3s ease;
  }

  @keyframes modalSlideIn {
    from {
      opacity: 0;
      transform: translateY(-50px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .modal-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 20px 30px;
    border-radius: 15px 15px 0 0;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .modal-header h4 {
    margin: 0;
    font-weight: 600;
  }

  .modal-header .close-modal {
    background: none;
    border: none;
    color: white;
    font-size: 1.5rem;
    cursor: pointer;
    opacity: 0.8;
    transition: opacity 0.3s ease;
  }

  .modal-header .close-modal:hover {
    opacity: 1;
  }

  .modal-body {
    padding: 30px;
  }

  .form-group {
    margin-bottom: 20px;
  }

  .form-label {
    display: block;
    margin-bottom: 8px;
    font-weight: 500;
    color: #555;
  }

  .form-control {
    width: 100%;
    padding: 12px 15px;
    border: 2px solid #e1e5e9;
    border-radius: 10px;
    font-size: 0.95rem;
    transition: all 0.3s ease;
    background: #f8f9fa;
  }

  .form-control:focus {
    border-color: #667eea;
    background: white;
    box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    outline: none;
  }

  .form-control.error {
    border-color: #e74c3c;
    background: #fff5f5;
  }

  .error-message {
    color: #e74c3c;
    font-size: 0.85rem;
    margin-top: 5px;
    display: flex;
    align-items: center;
    gap: 5px;
  }

  .btn-submit {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    padding: 12px 30px;
    border-radius: 10px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    width: 100%;
    margin-top: 10px;
  }

  .btn-submit:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
  }

  /* Alerts */
  .alert {
    padding: 15px 20px;
    border-radius: 10px;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .alert-success {
    background: rgba(46, 204, 113, 0.1);
    color: #2ecc71;
    border: 1px solid rgba(46, 204, 113, 0.2);
  }

  .alert-error {
    background: rgba(231, 76, 60, 0.1);
    color: #e74c3c;
    border: 1px solid rgba(231, 76, 60, 0.2);
  }

  /* Pagination */
  .pagination-container {
    display: flex;
    justify-content: center;
    margin-top: 30px;
    padding: 20px;
  }

  .pagination {
    display: flex;
    gap: 10px;
    align-items: center;
  }

  .page-link {
    padding: 8px 15px;
    border-radius: 8px;
    background: #f8f9fa;
    color: #667eea;
    text-decoration: none;
    font-weight: 500;
    transition: all 0.3s ease;
    border: 1px solid #e1e5e9;
  }

  .page-link:hover {
    background: #667eea;
    color: white;
    border-color: #667eea;
  }

  .page-link.active {
    background: #667eea;
    color: white;
    border-color: #667eea;
  }

  .page-link.disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  /* Responsive Design */
  @media (max-width: 768px) {
    .coupon-card {
      padding: 15px;
    }
    
    .coupon-actions {
      flex-direction: column;
    }
    
    .modal-content {
      width: 95%;
      margin: 10px;
    }
    
    .modal-body {
      padding: 20px;
    }
  }

  /* Empty State */
  .empty-state {
    text-align: center;
    padding: 50px 20px;
    color: #666;
  }

  .empty-state i {
    font-size: 3rem;
    color: #bdc3c7;
    margin-bottom: 20px;
  }

  .empty-state h4 {
    color: #7f8c8d;
    margin-bottom: 10px;
  }

  /* Loading State */
  .loading {
    position: relative;
    opacity: 0.7;
  }

  .loading::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 30px;
    height: 30px;
    border: 3px solid #667eea;
    border-radius: 50%;
    border-top-color: transparent;
    animation: spin 1s linear infinite;
  }

  @keyframes spin {
    to { transform: translate(-50%, -50%) rotate(360deg); }
  }
</style>
<div class="container-scroller">
  <!-- Sidebar -->
  <%- include('./layout/sideBar.ejs') -%>

  <div class="container-fluid page-body-wrapper">
    <div class="main-panel">
      <div class="content-wrapper">
        <!-- Coupon Container -->
        <div class="coupon-container">
          <!-- Header -->
          <div class="coupon-header d-flex justify-content-between align-items-center">
            <h3>
              <i class="fas fa-ticket-alt me-2"></i>
              Coupon Management
            </h3>
            <button class="btn-add" id="addCouponBtn">
              <i class="fas fa-plus me-2"></i>
              Add New Coupon
            </button>
          </div>

          <!-- Alerts -->
          <% if (success) { %>
            <div class="alert alert-success mx-4 mt-4">
              <i class="fas fa-check-circle"></i>
              <%= success %>
            </div>
          <% } %>
          
          <% if (error) { %>
            <div class="alert alert-error mx-4 mt-4">
              <i class="fas fa-exclamation-circle"></i>
              <%= error %>
            </div>
          <% } %>

          <!-- Coupon Grid -->
          <div class="coupon-table">
            <% if (coupons && coupons.length > 0) { %>
              <div class="row">
                <% coupons.forEach((coupon, index) => { 
                  const isExpired = new Date(coupon.expiryDate) < new Date();
                  const isActive = coupon.isActive && !isExpired;
                  const statusClass = isExpired ? 'status-expired' : 
                                     coupon.isActive ? 'status-active' : 'status-inactive';
                  const statusText = isExpired ? 'Expired' : 
                                    coupon.isActive ? 'Active' : 'Inactive';
                %>
                  <div class="col-md-6 col-lg-4 mb-4">
                    <div class="coupon-card">
                      <div class="coupon-code">
                        <i class="fas fa-tag me-2"></i>
                        <%= coupon.couponCode %>
                      </div>
                      
                      <h4 class="coupon-name">
                        <%= coupon.couponName %>
                      </h4>
                      
                      <div class="coupon-details">
                        <i class="fas fa-percentage"></i>
                        <span><strong><%= coupon.discountPercentage %>%</strong> discount</span>
                      </div>
                      
                      <div class="coupon-details">
                        <i class="fas fa-dollar-sign"></i>
                        <span>Min order: <strong>₹<%= coupon.minOrderAmount %></strong></span>
                      </div>
                      
                      <% if (coupon.maxDiscountAmount) { %>
                        <div class="coupon-details">
                          <i class="fas fa-trophy"></i>
                          <span>Max discount: <strong>₹<%= coupon.maxDiscountAmount %></strong></span>
                        </div>
                      <% } %>
                      
                      <div class="coupon-details">
                        <i class="fas fa-calendar-alt"></i>
                        <span>Valid: <%= new Date(coupon.startDate).toLocaleDateString() %> - 
                              <%= new Date(coupon.expiryDate).toLocaleDateString() %></span>
                      </div>
                      
                      <div class="coupon-details">
                        <i class="fas fa-users"></i>
                        <span>Used: <%= coupon.usedCount %> 
                          <% if (coupon.usageLimit) { %>
                            / <%= coupon.usageLimit %>
                          <% } else { %>
                            (Unlimited)
                          <% } %>
                        </span>
                      </div>
                      
                      <div class="d-flex justify-content-between align-items-center mt-3">
                        <span class="coupon-status <%= statusClass %>">
                          <%= statusText %>
                        </span>
                        
                        <div class="coupon-actions">
                          <% if (!isExpired) { %>
                            <button class="btn btn-toggle" 
                                    onclick="toggleCoupon('<%= coupon._id %>')"
                                    data-id="<%= coupon._id %>">
                              <%= coupon.isActive ? 'Deactivate' : 'Activate' %>
                            </button>
                          <% } %>
                          <button class="btn btn-delete" 
                                  onclick="deleteCoupon('<%= coupon._id %>')"
                                  data-id="<%= coupon._id %>">
                            Delete
                          </button>
                        </div>
                      </div>
                    </div>
                  </div>
                <% }); %>
              </div>
            <% } else { %>
              <div class="empty-state">
                <i class="fas fa-ticket-alt"></i>
                <h4>No Coupons Found</h4>
                <p>Click "Add New Coupon" to create your first coupon</p>
              </div>
            <% } %>

            <!-- Pagination -->
            <% if (totalPages > 1) { %>
              <div class="pagination-container">
                <div class="pagination">
                  <% if (currentPage > 1) { %>
                    <a href="?page=<%= currentPage - 1 %>" class="page-link">
                      <i class="fas fa-chevron-left"></i>
                    </a>
                  <% } else { %>
                    <span class="page-link disabled">
                      <i class="fas fa-chevron-left"></i>
                    </span>
                  <% } %>

                  <% for (let i = 1; i <= totalPages; i++) { %>
                    <a href="?page=<%= i %>" 
                       class="page-link <%= i === currentPage ? 'active' : '' %>">
                      <%= i %>
                    </a>
                  <% } %>

                  <% if (currentPage < totalPages) { %>
                    <a href="?page=<%= currentPage + 1 %>" class="page-link">
                      <i class="fas fa-chevron-right"></i>
                    </a>
                  <% } else { %>
                    <span class="page-link disabled">
                      <i class="fas fa-chevron-right"></i>
                    </span>
                  <% } %>
                </div>
              </div>
            <% } %>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Add Coupon Modal -->
<div class="modal-overlay" id="couponModal">
  <div class="modal-content">
    <div class="modal-header">
      <h4><i class="fas fa-plus-circle me-2"></i>Add New Coupon</h4>
      <button class="close-modal" id="closeModal">&times;</button>
    </div>
    
    <div class="modal-body">
      <form id="couponForm" method="POST" action="/admin/addCoupon">
        <!-- Coupon Name -->
        <div class="form-group">
          <label class="form-label">Coupon Name *</label>
          <input type="text" 
                 name="couponName" 
                 class="form-control <%= errors && errors.couponName ? 'error' : '' %>"
                 value="<%= formData && formData.couponName ? formData.couponName : '' %>"
                 placeholder="E.g., Summer Sale 2024">
          <% if (errors && errors.couponName) { %>
            <div class="error-message">
              <i class="fas fa-exclamation-circle"></i>
              <%= errors.couponName %>
            </div>
          <% } %>
        </div>

        <!-- Coupon Code -->
        <div class="form-group">
          <label class="form-label">Coupon Code *</label>
          <input type="text" 
                 name="couponCode" 
                 class="form-control <%= errors && errors.couponCode ? 'error' : '' %>"
                 value="<%= formData && formData.couponCode ? formData.couponCode : '' %>"
                 placeholder="E.g., SUMMER2024">
          <% if (errors && errors.couponCode) { %>
            <div class="error-message">
              <i class="fas fa-exclamation-circle"></i>
              <%= errors.couponCode %>
            </div>
          <% } %>
        </div>

        <!-- Discount Percentage -->
        <div class="form-group">
          <label class="form-label">Discount Percentage *</label>
          <input type="number" 
                 name="discountPercentage" 
                 min="1" 
                 max="100" 
                 class="form-control <%= errors && errors.discountPercentage ? 'error' : '' %>"
                 value="<%= formData && formData.discountPercentage ? formData.discountPercentage : '' %>"
                 placeholder="E.g., 10">
          <% if (errors && errors.discountPercentage) { %>
            <div class="error-message">
              <i class="fas fa-exclamation-circle"></i>
              <%= errors.discountPercentage %>
            </div>
          <% } %>
        </div>

        <!-- Minimum Order Amount -->
        <div class="form-group">
          <label class="form-label">Minimum Order Amount *</label>
          <input type="number" 
                 name="minOrderAmount" 
                 min="0" 
                 step="0.01"
                 class="form-control <%= errors && errors.minOrderAmount ? 'error' : '' %>"
                 value="<%= formData && formData.minOrderAmount ? formData.minOrderAmount : '' %>"
                 placeholder="E.g., 500.00">
          <% if (errors && errors.minOrderAmount) { %>
            <div class="error-message">
              <i class="fas fa-exclamation-circle"></i>
              <%= errors.minOrderAmount %>
            </div>
          <% } %>
        </div>

        <!-- Maximum Discount Amount -->
        <div class="form-group">
          <label class="form-label">Maximum Discount Amount (Optional)</label>
          <input type="number" 
                 name="maxDiscountAmount" 
                 min="0" 
                 step="0.01"
                 class="form-control <%= errors && errors.maxDiscountAmount ? 'error' : '' %>"
                 value="<%= formData && formData.maxDiscountAmount ? formData.maxDiscountAmount : '' %>"
                 placeholder="E.g., 1000.00">
          <% if (errors && errors.maxDiscountAmount) { %>
            <div class="error-message">
              <i class="fas fa-exclamation-circle"></i>
              <%= errors.maxDiscountAmount %>
            </div>
          <% } %>
        </div>

        <!-- Start Date -->
        <div class="form-group">
          <label class="form-label">Start Date *</label>
          <input type="date" 
                 name="startDate" 
                 class="form-control <%= errors && errors.startDate ? 'error' : '' %>"
                 value="<%= formData && formData.startDate ? formData.startDate : '' %>">
          <% if (errors && errors.startDate) { %>
            <div class="error-message">
              <i class="fas fa-exclamation-circle"></i>
              <%= errors.startDate %>
            </div>
          <% } %>
        </div>

        <!-- Expiry Date -->
        <div class="form-group">
          <label class="form-label">Expiry Date *</label>
          <input type="date" 
                 name="expiryDate" 
                 class="form-control <%= errors && errors.expiryDate ? 'error' : '' %>"
                 value="<%= formData && formData.expiryDate ? formData.expiryDate : '' %>">
          <% if (errors && errors.expiryDate) { %>
            <div class="error-message">
              <i class="fas fa-exclamation-circle"></i>
              <%= errors.expiryDate %>
            </div>
          <% } %>
        </div>

        <!-- Usage Limit -->
        <div class="form-group">
          <label class="form-label">Usage Limit (Optional - leave empty for unlimited)</label>
          <input type="number" 
                 name="usageLimit" 
                 min="1"
                 class="form-control <%= errors && errors.usageLimit ? 'error' : '' %>"
                 value="<%= formData && formData.usageLimit ? formData.usageLimit : '' %>"
                 placeholder="E.g., 100">
          <% if (errors && errors.usageLimit) { %>
            <div class="error-message">
              <i class="fas fa-exclamation-circle"></i>
              <%= errors.usageLimit %>
            </div>
          <% } %>
        </div>

        <!-- User Limit -->
        <div class="form-group">
          <label class="form-label">Usage Limit Per User *</label>
          <input type="number" 
                 name="userLimit" 
                 min="1"
                 class="form-control <%= errors && errors.userLimit ? 'error' : '' %>"
                 value="<%= formData && formData.userLimit ? formData.userLimit : 1 %>"
                 placeholder="E.g., 1">
          <% if (errors && errors.userLimit) { %>
            <div class="error-message">
              <i class="fas fa-exclamation-circle"></i>
              <%= errors.userLimit %>
            </div>
          <% } %>
        </div>

        <button type="submit" class="btn-submit">
          <i class="fas fa-save me-2"></i>
          Create Coupon
        </button>
      </form>
    </div>
  </div>
</div>

<!-- Scripts -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
  // Modal handling
  const modal = document.getElementById('couponModal');
  const addBtn = document.getElementById('addCouponBtn');
  const closeBtn = document.getElementById('closeModal');
  const form = document.getElementById('couponForm');

  // Open modal
  addBtn.addEventListener('click', () => {
    modal.style.display = 'flex';
    document.body.style.overflow = 'hidden';
  });

  // Close modal
  closeBtn.addEventListener('click', () => {
    modal.style.display = 'none';
    document.body.style.overflow = 'auto';
  });

  // Close modal when clicking outside
  modal.addEventListener('click', (e) => {
    if (e.target === modal) {
      modal.style.display = 'none';
      document.body.style.overflow = 'auto';
    }
  });

  // Toggle coupon status
  async function toggleCoupon(couponId) {
    const button = event.target;
    const originalText = button.textContent;
    
    try {
      button.classList.add('loading');
      button.disabled = true;
      
      const response = await fetch(`/admin/coupon/${couponId}/toggle`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        }
      });
      
      const data = await response.json();
      
      if (data.success) {
        // Update button text and status display
        const statusSpan = button.closest('.coupon-card').querySelector('.coupon-status');
        const isCurrentlyActive = statusSpan.classList.contains('status-active');
        
        if (isCurrentlyActive) {
          statusSpan.textContent = 'Inactive';
          statusSpan.className = 'coupon-status status-inactive';
          button.textContent = 'Activate';
        } else {
          statusSpan.textContent = 'Active';
          statusSpan.className = 'coupon-status status-active';
          button.textContent = 'Deactivate';
        }
        
        Swal.fire({
          icon: 'success',
          title: 'Success!',
          text: data.message,
          timer: 2000,
          showConfirmButton: false
        });
      } else {
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: data.message
        });
      }
    } catch (error) {
      console.error('Error:', error);
      Swal.fire({
        icon: 'error',
        title: 'Error',
        text: 'Failed to update coupon status'
      });
    } finally {
      button.classList.remove('loading');
      button.disabled = false;
    }
  }

  // Delete coupon
  async function deleteCoupon(couponId) {
    const result = await Swal.fire({
      title: 'Are you sure?',
      text: "You won't be able to revert this!",
      icon: 'warning',
      showCancelButton: true,
      confirmButtonColor: '#3085d6',
      cancelButtonColor: '#d33',
      confirmButtonText: 'Yes, delete it!'
    });
    
    if (result.isConfirmed) {
      const button = event.target;
      
      try {
        button.classList.add('loading');
        button.disabled = true;
        
        const response = await fetch(`/admin/coupon/${couponId}/delete`, {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json'
          }
        });
        
        const data = await response.json();
        
        if (data.success) {
          // Remove coupon card from DOM
          const couponCard = button.closest('.coupon-card');
          couponCard.style.opacity = '0';
          couponCard.style.transform = 'scale(0.9)';
          
          setTimeout(() => {
            couponCard.remove();
            
            // Check if no coupons left
            const couponCards = document.querySelectorAll('.coupon-card');
            if (couponCards.length === 0) {
              // Reload page to show empty state
              location.reload();
            }
          }, 300);
          
          Swal.fire({
            icon: 'success',
            title: 'Deleted!',
            text: data.message,
            timer: 2000,
            showConfirmButton: false
          });
        } else {
          Swal.fire({
            icon: 'error',
            title: 'Error',
            text: data.message
          });
        }
      } catch (error) {
        console.error('Error:', error);
        Swal.fire({
          icon: 'error',
          title: 'Error',
          text: 'Failed to delete coupon'
        });
      } finally {
        button.classList.remove('loading');
        button.disabled = false;
      }
    }
  }

  // Form validation
  form.addEventListener('submit', (e) => {
    const today = new Date().toISOString().split('T')[0];
    const startDate = form.querySelector('input[name="startDate"]').value;
    const expiryDate = form.querySelector('input[name="expiryDate"]').value;
    
    // Validate dates
    if (startDate < today) {
      e.preventDefault();
      Swal.fire({
        icon: 'error',
        title: 'Invalid Date',
        text: 'Start date cannot be in the past'
      });
      return;
    }
    
    if (expiryDate <= startDate) {
      e.preventDefault();
      Swal.fire({
        icon: 'error',
        title: 'Invalid Date',
        text: 'Expiry date must be after start date'
      });
      return;
    }
  });

  // Auto-close success/error alerts after 5 seconds
  document.addEventListener('DOMContentLoaded', () => {
    const alerts = document.querySelectorAll('.alert');
    alerts.forEach(alert => {
      setTimeout(() => {
        alert.style.opacity = '0';
        alert.style.transform = 'translateY(-10px)';
        setTimeout(() => alert.remove(), 300);
      }, 5000);
    });
  });
</script>

<%- include('./layout/footer') -%>