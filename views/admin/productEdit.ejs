<%- include('./layout/header.ejs')-%>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" integrity="sha512-Cnqt0n8e6F5v2mKRA1VT3O42XjzqstTxwabylgh+IbpgrvuJh0tN17ABX4nvmTvjG1yWmlG6h7Qq5ROJdgy0mA==" crossorigin="anonymous" />

    <div class="container-scroller">
  <%- include('./layout/sideBar.ejs') -%>
  <div class="container-fluid page-body-wrapper">
    <div class="main-panel">
      <div class="content-wrapper">
        <div class="row">
          <div class="col-md-12 grid-margin stretch-card">
            <div class="card">
              <div class="card-body">
                <h4 class="card-title mb-3">Edit Product</h4>

                <form id="editProductForm" class="forms-sample" enctype="multipart/form-data">
                  <input type="hidden" name="productId" value="<%= product._id %>">

                  <!-- Name -->
                  <div class="form-group">
                    <label>Product Name</label>
                    <input type="text" class="form-control" name="name" value="<%= product.name %>">
                    <% if(errors && errors.name){%>
                      <p style="color: tomato;"><%= errors.name %></p>
                    <% } %>
                  </div>

                  <!-- Price -->
                  <div class="form-group">
                    <label>Price (â‚¹)</label>
                    <input type="number" class="form-control" name="price" value="<%= product.price %>" min="0">
                    <% if(errors && errors.price){%>
                      <p style="color: tomato;"><%= errors.price %></p>
                    <% } %>
                  </div>

                  <!-- Description -->
                  <div class="form-group">
                    <label>Description</label>
                    <textarea class="form-control" name="description" rows="3"><%= product.description %></textarea>
                    <% if(errors && errors.description){%>
                      <p style="color: tomato;"><%= errors.description %></p>
                    <% } %>
                  </div>

                  <!-- Category -->
                  <div class="form-group">
                    <label>Category</label>
                    <select class="form-control" name="category">
                      <% categories.forEach(cat => { %>
                        <option value="<%= cat._id %>" <%= product.category.toString() === cat._id.toString() ? 'selected' : '' %>>
                          <%= cat.name %>
                        </option>
                      <% }) %>
                    </select>
                  </div>

                  <!-- Brand -->
                  <div class="form-group">
                    <label>Brand</label>
                   
                    
                    <select class="form-control" name="brand">
                    
                      <% brands.forEach(b => { %>
                        <option value="<%= b._id %>" <%= product.brand.toString() === b._id.toString() ? 'selected' : '' %>>
                          <%= b.name %>
                        </option>
                      <% }) %>
                    </select>
                  </div>

                  <!-- Variants -->
                  <div class="form-group">
                    <label>Variants (Size + Stock)</label>
                    <div id="variants-container">
                      <% product.variants.forEach((variant, i) => { %>
                        <div class="d-flex mb-2">
                          <select class="form-control mr-2" name="variants[<%= i %>][size]">
                            <option <%= variant.size === 'XS' ? 'selected' : '' %>>XS</option>
                            <option <%= variant.size === 'S' ? 'selected' : '' %>>S</option>
                            <option <%= variant.size === 'M' ? 'selected' : '' %>>M</option>
                            <option <%= variant.size === 'L' ? 'selected' : '' %>>L</option>
                            <option <%= variant.size === 'XL' ? 'selected' : '' %>>XL</option>
                            <option <%= variant.size === 'XXL' ? 'selected' : '' %>>XXL</option>
                          </select>
                          <input type="number" class="form-control" name="variants[<%= i %>][stock]" value="<%= variant.stock %>" min="0">
                        </div>
                      <% }) %>
                    </div>
                    <button type="button" class="btn btn-sm btn-secondary mt-2" onclick="addVariant()">+ Add Variant</button>
                  </div>

                  <!-- Existing Images -->
                  <div class="form-group">
                    <label>Existing Images</label>
                    <div class="row">
                      <% product.images.forEach(image => { %>
                        <div class="col-md-2 mb-2">
                          <img src="/<%= image %>" style="height: 120px; width: 100px; object-fit: cover;">
                          <button type="button" class="btn btn-danger btn-sm mt-1"
                            onclick="deleteExistingImage('<%= product._id %>', '<%= image %>')">Delete</button>
                        </div>
                      <% }) %>
                    </div>
                  </div>

                  <!-- Upload New Images -->
                  <div class="form-group">
                    <label>Upload New Images</label>
                    <input type="file" class="form-control" name="images" multiple accept="image/*">
                  </div>

              

                  <!-- Submit -->
                  <button type="submit" class="btn btn-primary mr-2">Update</button>
                  <a href="/admin/productDetails" class="btn btn-dark">Cancel</a>
                </form>

              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script src="/javascripts/ajax.js"></script>

    <script>
function addVariant() {
  const container = document.getElementById("variants-container");
  const index = container.children.length;
  const div = document.createElement("div");
  div.className = "d-flex mb-2";
  div.innerHTML = `
    <select class="form-control mr-2" name="variants[${index}][size]">
      <option>XS</option><option>S</option><option>M</option>
      <option>L</option><option>XL</option><option>XXL</option>
    </select>
    <input type="number" class="form-control" name="variants[${index}][stock]" value="0" min="0">
  `;
  container.appendChild(div);
}

function deleteExistingImage(productId, fileName) {
  fetch(`/admin/products/${productId}/images?fileName=${fileName}`, {
    method: 'DELETE'
  })
  .then(res => res.json())
  .then(data => {
  if (data.success) {
      document.querySelector(`img[src="/${fileName}"]`).parentElement.remove();
    }
  })
  .catch(err => console.error(err));
}
</script>


    <script>
        function viewImage(event) {
          const imageList = document.getElementById('imgView');
          const files = event.target.files;
          const fileNames = [];
      
          for (let i = 0; i < files.length; i++) {
            fileNames.push(files[i].name);
      
            // Create a new container for each image
            const colDiv = document.createElement('div');
            colDiv.className = 'col-md-2 mb-2';
      
            const listItem = document.createElement('div');
      
            const img = document.createElement('img');
            img.src = URL.createObjectURL(files[i]);
            img.alt = 'Product Image';
            img.style.height = '200px';
      
            // Attach a click event listener to each image
            img.addEventListener('click', function() {
              deleteImage(fileNames.indexOf(files[i].name));
            });
      
            listItem.appendChild(img);
            colDiv.appendChild(listItem);
      
            imageList.appendChild(colDiv);
          }
          imageList.setAttribute('data-file-names', JSON.stringify(fileNames));
        }
      
        function deleteImage(index) {
        const imageList = document.getElementById('imgView');
        const images = imageList.getElementsByClassName('col-md-2');
        const inputElement = document.getElementById('imageInput');
      
        if (index >= 0 && index < images.length) {
          // Retrieve file names from the data attribute
          const fileNames = JSON.parse(imageList.getAttribute('data-file-names'));
      
          // Remove the deleted image from the fileNames array
          fileNames.splice(index, 1);
      
          // Update the data-file-names attribute
          imageList.setAttribute('data-file-names', JSON.stringify(fileNames));
      
          // Remove the corresponding image container
          images[index].parentNode.removeChild(images[index]);
      
          // Update the input files to remove the deselected image
          const newFiles = Array.from(inputElement.files);
          newFiles.splice(index, 1);
      
          // Create a new FileList and assign it to the input files
          const newFileList = new DataTransfer();
          newFiles.forEach(file => newFileList.items.add(file));
      
          inputElement.files = newFileList.files;
          imageList.innerHTML = '';
    fileNames.forEach((fileName, i) => {
      const colDiv = document.createElement('div');
      colDiv.className = 'col-md-2 mb-2';

      const listItem = document.createElement('div');

      const img = document.createElement('img');
      img.src = URL.createObjectURL(newFiles[i]);
      img.alt = 'Product Image';
      img.style.height = '200px';

      // Attach a click event listener to each image
      img.addEventListener('click', function() {
        deleteImage(i);
      });

      listItem.appendChild(img);
      colDiv.appendChild(listItem);

      imageList.appendChild(colDiv);
    });
  }
}
      
      </script>
      

      <script>
  document.getElementById("editProductForm").addEventListener("submit", async (e) => {
    e.preventDefault();
  console.log("the submition was working ")
    const form = e.target;
    const formData = new FormData(form);
    const productId = formData.get("productId");

    const result = await ajaxRequest(`/admin/products/${productId}`, "PUT", formData, true);

    if (result.success) {
        window.location.href = "/admin/productDetails";
    } else {
      if (result.errors && typeof result.errors === "object") {
        // Clear previous errors first
        document.querySelectorAll(".error-msg").forEach(el => el.innerText = "");

        if (result.errors.name) {
          document.getElementById("productNameError").innerText = result.errors.name;
        }
        if (result.errors.price) {
          document.getElementById("productPriceError").innerText = result.errors.price;
        }
        if (result.errors.description) {
          document.getElementById("productDescriptionError").innerText = result.errors.description;
        }
        if (result.errors.category) {
          document.getElementById("productCategoryError").innerText = result.errors.category;
        }
        if (result.errors.brand) {
          document.getElementById("productBrandError").innerText = result.errors.brand;
        }
        if (result.errors.images) {
          document.getElementById("productImagesError").innerText = result.errors.images;
        }
      } else {
        Toastify({
          text: result.message || "Something went wrong",
          duration: 4000,
          gravity: "top",
          position: "right",
          backgroundColor: "red",
          stopOnFocus: true
        }).showToast();
      }
    }
  });
</script>

      
      
      <!-- ... Remaining HTML code ... -->
      
      
      
      
      
      
      
      
      
      
          
              
           
          
          <%- include('./layout/footer')-%>