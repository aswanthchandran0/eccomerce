<%- include('./layout/header.ejs')-%>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" integrity="sha512-Cnqt0n8e6F5v2mKRA1VT3O42XjzqstTxwabylgh+IbpgrvuJh0tN17ABX4nvmTvjG1yWmlG6h7Qq5ROJdgy0mA==" crossorigin="anonymous" />

    <div class="container-scroller">
      <!-- partial:partials/_sidebar.html -->
    <%- include('./layout/sideBar.ejs') -%>
      <!-- partial -->
      <div class="container-fluid page-body-wrapper">
        <!-- partial:partials/_navbar.html -->
     
        <!-- partial -->
        <div class="main-panel">
          <div class="content-wrapper">
           
            <div class="row">
             
              <div class="col-md-12 grid-margin stretch-card">
                <div class="card">
                  <div class="card-body">
                    <div class="d-flex flex-row justify-content-between">
                      <h4 class="card-title mb-1">Product add</h4>
                      <p class="text-muted mb-1"></p>
                    </div>
                    <div class="row">
                      <div class="col-12">
                        <div class="preview-list">
                          <!---->
                          
                              
                              <p class="card-description">  </p>
                              <p class="card-description">  </p>
                           <form id="productForm" class="forms-sample" enctype="multipart/form-data">
  <!-- Product Name -->
  <div class="form-group">
    <label for="name">Product Name</label>
    <input 
      type="text" 
      class="form-control" 
      id="name" 
      name="name" 
      placeholder="Product Name"
    >
    <% if(errors && errors.name){ %>
      <p style="color: tomato;"><%= errors.name %></p>
    <% } %>
  </div>

  <!-- Price -->
  <div class="form-group">
    <label for="price">Product Price</label>
    <input 
      type="number" 
      class="form-control" 
      id="price" 
      name="price" 
      placeholder="₹0.00" 
      min="1"
    >
    <% if(errors && errors.price){ %>
      <p style="color: tomato;"><%= errors.price %></p>
    <% } %>
  </div>

  <!-- Category -->
  <div class="form-group">
    <label for="category">Category</label>
    <select class="form-control" id="category" name="category">
      <% if (categories && categories.length > 0) { %>
      <% categories.forEach(c => { %>
        <option value="<%= c._id %>"><%= c.name %></option>
      <% }); %>
    <% } else { %>
      <option disabled selected>No categories available</option>
    <% } %>
    </select>
    <% if(errors && errors.category){ %>
      <p style="color: tomato;"><%= errors.category %></p>
    <% } %>
  </div>

  <!-- Brand -->
  <div class="form-group">
    <label for="brand">Brand</label>
    <select class="form-control" id="brand" name="brand">
      <% brands.forEach(b => { %>
        <option value="<%= b._id %>"><%= b.name %></option>
      <% }); %>
    </select>
    <% if(errors && errors.brand){ %>
      <p style="color: tomato;"><%= errors.brand %></p>
    <% } %>
  </div>

  <!-- Variants (example: size + stock) -->

  <div class="form-group">
  <label for="variants">Variants (Size & Count)</label>
  <div id="variantList"></div>

  <select id="size">
    <option value="M">M</option>
    <option value="L">L</option>
    <option value="XL">XL</option>
  </select>

  <input type="number" id="stock" placeholder="Stock" min="1" class="form-control mb-1"  />
  <small id="variantError" class="text-danger"></small> 
  <button type="button" onclick="addVariant()" class="btn btn-sm btn-secondary mt-2">Add Variant</button>
</div>


  <!-- Description -->
  <div class="form-group">
    <label for="description">Product Description</label>
    <textarea class="form-control" id="description" name="description" rows="4"></textarea>
    <% if(errors && errors.description){ %>
      <p style="color: tomato;"><%= errors.description %></p>
    <% } %>
  </div>

  <!-- Images -->
  <div class="form-group">
    <label for="images">Product Images</label>
    <input 
      type="file" 
      class="form-control" 
      id="images" 
      name="images" 
      multiple 
      accept="image/*"
    >
  </div>

  <div class="row" id="imgView"></div>

  <!-- Submit -->
  <button type="submit" class="btn btn-primary mr-2">Submit</button>
  <button type="button" class="btn btn-dark" id="cancelBtn">Cancel</button>
</form>

                              
                              
                        
                          
                          
                            
            
                         <!---->

                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
           
           


          </div>
          <!-- content-wrapper ends -->
          <!-- partial:partials/_footer.html -->
         
          <!-- partial -->
        </div>
        <!-- main-panel ends -->
      </div>
      <!-- page-body-wrapper ends -->
    </div>

    <!-- Product Edit Modal -->
<div class="modal fade" id="editProductModal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-centered" role="document">
    <div class="modal-content bg-dark text-light">
      <div class="modal-header border-0">
        <h5 class="modal-title">Edit Product</h5>
        <button type="button" class="close text-light" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>

      <div class="modal-body">
        <form id="editProductForm" class="forms-sample" enctype="multipart/form-data">
          <input type="hidden" id="edit_productId" name="productId">

          <!-- Name -->
          <div class="form-group">
            <label for="edit_name">Product Name</label>
            <input type="text" class="form-control bg-secondary text-light" id="edit_name" name="name">
            <small class="text-danger" id="edit_name_error"></small>
          </div>

          <!-- Price -->
          <div class="form-group">
            <label for="edit_price">Price</label>
            <input type="number" class="form-control bg-secondary text-light" id="edit_price" name="price" min="1">
            <small class="text-danger" id="edit_price_error"></small>
          </div>

          <!-- Category -->
          <div class="form-group">
            <label for="edit_category">Category</label>
            <select class="form-control bg-secondary text-light" id="edit_category" name="category">
              <% categories.forEach(c => { %>
                <option value="<%= c._id %>"><%= c.name %></option>
              <% }); %>
            </select>
            <small class="text-danger" id="edit_category_error"></small>
          </div>

          <!-- Brand -->
          <div class="form-group">
            <label for="edit_brand">Brand</label>
            <select class="form-control bg-secondary text-light" id="edit_brand" name="brand">
              <% brands.forEach(b => { %>
                <option value="<%= b._id %>"><%= b.name %></option>
              <% }); %>
            </select>
            <small class="text-danger" id="edit_brand_error"></small>
          </div>

          <!-- Variants -->
          <div class="form-group">
            <label>Variants</label>
            <div id="edit_variantList"></div>
            <div class="d-flex">
              <select id="edit_size" class="form-control w-25 mr-2">
                <option value="M">M</option><option value="L">L</option><option value="XL">XL</option>
              </select>
              <input type="number" id="edit_stock" class="form-control w-25 mr-2" placeholder="Stock" min="1">
              <button type="button" class="btn btn-sm btn-secondary" onclick="addEditVariant()">Add</button>
            </div>
            <small class="text-danger" id="edit_variantError"></small>
          </div>

          <!-- Description -->
          <div class="form-group">
            <label for="edit_description">Description</label>
            <textarea class="form-control bg-secondary text-light" id="edit_description" name="description" rows="3"></textarea>
            <small class="text-danger" id="edit_description_error"></small>
          </div>

          <!-- Images -->
          <div class="form-group">
            <label for="edit_images">Images</label>
            <input type="file" id="edit_images" name="images" multiple accept="image/*" class="form-control bg-secondary text-light">
          </div>
          <div class="row" id="edit_imgView"></div>

          <!-- Buttons -->
          <div class="text-right">
            <button type="submit" class="btn btn-primary">Save Changes</button>
            <button type="button" class="btn btn-outline-light" data-dismiss="modal">Cancel</button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>



    <script src="https://code.jquery.com/jquery-3.6.4.min.js"></script>
    <script src="/javascripts/ajax.js"></script> 

<script>
let selectedFiles = []; // store files temporarily

document.getElementById("images").addEventListener("change", function (event) {
  // convert FileList to array and add to selectedFiles
  selectedFiles = Array.from(event.target.files);
  renderPreviews();
});

function renderPreviews() {
  const imageList = document.getElementById("imgView");
  imageList.innerHTML = ""; // clear previous previews

  selectedFiles.forEach((file, index) => {
    const colDiv = document.createElement("div");
    colDiv.className = "col-md-2 mb-2 position-relative";

    const img = document.createElement("img");
    img.src = URL.createObjectURL(file);
    img.alt = "Product Image";
    img.style.height = "150px";
    img.style.width = "100%";
    img.className = "img-thumbnail";

    // delete button
    const btn = document.createElement("button");
    btn.innerHTML = "&times;";
    btn.className = "btn btn-danger btn-sm position-absolute top-0 end-0";
    btn.onclick = function () {
      deleteImage(index);
    };

    colDiv.appendChild(img);
    colDiv.appendChild(btn);
    imageList.appendChild(colDiv);
  });
}

function deleteImage(index) {
  selectedFiles.splice(index, 1); // remove from array
  renderPreviews();

  // also reset the input’s FileList
  const dataTransfer = new DataTransfer();
  selectedFiles.forEach((file) => dataTransfer.items.add(file));
  document.getElementById("images").files = dataTransfer.files;
}
</script>


<script>
let variants = []; // store added variants

function addVariant() {
  const size = document.getElementById("size").value;
  const stock = parseInt(document.getElementById("stock").value);

  const errorBox = document.getElementById("variantError");
  errorBox.textContent = ""; // clear previous errors

  if (!stock || stock <= 0) {
    errorBox.textContent = "Please enter a valid stock!";
    return;
  }

  const existing = variants.find(v => v.size === size);

  if (existing) {
    // update existing stock
    existing.stock = stock;
  } else {
    variants.push({ size, stock });
  }

  refreshVariantList();
  console.log("Current Variants:", variants);
}

function deleteVariant(size) {
  variants = variants.filter(v => v.size !== size);
  refreshVariantList();
}

function refreshVariantList() {
  const list = document.getElementById("variantList");
  list.innerHTML = ""; // clear old list

  variants.forEach(v => {
    const div = document.createElement("div");
    div.className = "d-flex justify-content-between align-items-center border p-2 mb-1 rounded";

    div.innerHTML = `
      <span>${v.size} : ${v.stock}</span>
      <button type="button" class="btn btn-sm btn-danger">Delete</button>
    `;

    // Add delete button functionality
    div.querySelector("button").addEventListener("click", () => deleteVariant(v.size));

    list.appendChild(div);
  });
}
</script>

<!-- data submition -->
<script>
  document.getElementById("productForm").addEventListener("submit", async (e) => {
  e.preventDefault();

  const form = e.target;
  const formData = new FormData(form);

  // Add variants manually
  formData.append("variants", JSON.stringify(variants));

  // Ensure correct files
  formData.delete("images");
  selectedFiles.forEach((file) => formData.append("images", file));

  const result = await ajaxRequest("/admin/products", "POST", formData, true);

  if (result.success) {
    // ✅ Redirect manually on frontend
    window.location.href = "/admin/productDetails";
  } else if (result.errors) {
    // Show validation errors
    document.querySelectorAll(".text-danger").forEach((el) => el.remove());

    Object.keys(result.errors).forEach((key) => {
      const errorMsg = result.errors[key];
      const input = document.getElementById(key);

      if (input) {
        let errorEl = document.createElement("small");
        errorEl.className = "text-danger d-block mt-1";
        errorEl.textContent = errorMsg;
        input.insertAdjacentElement("afterend", errorEl);
      } else {
        if (key === "variants") {
          document.getElementById("variantError").textContent = errorMsg;
        } else if (key === "images") {
          const imgInput = document.getElementById("images");
          let errorEl = document.createElement("small");
          errorEl.className = "text-danger d-block mt-1";
          errorEl.textContent = errorMsg;
          imgInput.insertAdjacentElement("afterend", errorEl);
        }
      }
    });
  } else {
    alert(result.message || "❌ Something went wrong");
  }
});

</script>

<!-- ... Remaining HTML code ... -->










    
        
     
    
    <%- include('./layout/footer.ejs')-%>